{% extends "base.html" %} {% block title %} {% if current_user.es_lector() %}
Clientes del Sistema {% else %} Carpetas de Usuarios {% endif %} {% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto px-6 py-8">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-3xl font-bold text-primary-dark">
        {% if current_user.es_lector() %} Clientes del Sistema {% else %}
        Carpetas de Usuarios {% endif %}
      </h1>
      <p class="text-gray-500 mt-1">
        {% if current_user.es_lector() %} Vista de clientes del sistema - Acceso
        de solo lectura {% else %} Vista general de todas las carpetas del
        sistema {% endif %}
      </p>
    </div>
    <div class="flex items-center space-x-3">
      {% if current_user.es_lector() %}
      <span
        class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800"
      >
        <i class="fas fa-eye mr-2"></i>
        Modo Lector
      </span>
      {% endif %}
      <a
        href="{{ url_for('main.dashboard_admin') }}"
        class="bg-blue-100 text-primary-dark rounded-lg px-4 py-2 font-medium hover:bg-blue-200 transition"
      >
        <i class="fas fa-arrow-left mr-2"></i>
        Volver al Dashboard
      </a>
    </div>
  </div>

  <!-- Informaci√≥n del Rol para Lectores -->
  {% if current_user.es_lector() %}
  <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
    <div class="flex items-center space-x-3 mb-3">
      <i class="fas fa-info-circle text-blue-600 text-xl"></i>
      <h3 class="text-lg font-medium text-blue-900">Modo Lector</h3>
    </div>
    <p class="text-blue-800 mb-4">
      Como usuario con rol de lector, puedes ver la informaci√≥n de los clientes
      pero no puedes realizar modificaciones. Esta es una vista de solo lectura
      para consulta y seguimiento.
    </p>
    <div class="flex flex-wrap gap-3">
      <span
        class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800"
      >
        <i class="fas fa-eye mr-2"></i>
        Solo Lectura
      </span>
      <span
        class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800"
      >
        <i class="fas fa-users mr-2"></i>
        Ver Clientes
      </span>
      <span
        class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-800"
      >
        <i class="fas fa-folder mr-2"></i>
        Ver Carpetas
      </span>
    </div>
  </div>
  {% endif %}

  <!-- Search -->
  <form
    method="get"
    action="{{ url_for('main.listar_carpetas') }}"
    class="mb-6"
  >
    <div>
      <input
        type="text"
        name="q"
        value="{{ request.args.get('q', '') }}"
        placeholder="üîç Buscar por nombre o email"
        class="w-[32rem] h-[3rem] text-sm px-4 py-3 rounded-xl border border-transparent focus:ring-2 focus:ring-blue-200 focus:outline-none placeholder-gray-400"
      />
    </div>
  </form>

  <!-- Tabla de usuarios -->
  <div
    class="bg-white rounded-2xl shadow-md border border-gray-100 overflow-hidden"
  >
    <div class="px-6 py-3 border-b bg-blue-50 flex items-center">
      <div class="flex items-center gap-2 text-primary-dark font-semibold">
        <i class="fas fa-users"></i>
        {% if current_user.es_lector() %} Clientes del Sistema {% else %}
        Usuarios y sus Carpetas {% endif %}
      </div>
      <span
        class="ml-auto text-xs font-bold bg-blue-100 text-primary-dark px-3 py-1 rounded-full"
      >
        {{ usuarios|length }} {% if current_user.es_lector() %} clientes {% else
        %} usuarios {% endif %}
      </span>
    </div>

    {% if usuarios %}
    <table class="min-w-full text-sm text-gray-700">
      <thead>
        <tr class="border-b text-gray-500">
          <th class="py-3 px-6 text-left">NOMBRE</th>
          <th class="py-3 px-2 text-left">EMAIL</th>
          <th class="py-3 px-2 text-left">ROL</th>
          <th class="py-3 px-2 text-right">ACCIONES</th>
        </tr>
      </thead>
      <tbody>
        {% for usuario in usuarios %}
        <!-- Fila de tabla en escritorio -->
        <tr
          class="border-b last:border-0 hover:bg-blue-50 transition hidden md:table-row"
        >
          <td class="flex items-center gap-3 py-3 px-6">
            <span
              class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-primary-dark font-bold text-lg"
            >
              {{ (usuario.nombre or usuario.email)[0]|upper }}
            </span>
            <div>
              <div class="font-semibold text-gray-900">
                {{ usuario.nombre_completo or usuario.email.split('@')[0] }}
              </div>
              <div class="text-xs text-gray-500">
                @{{ usuario.email.split('@')[0] }}
              </div>
            </div>
          </td>
          <td class="px-2">{{ usuario.email }}</td>
          <td class="px-2">
            <span
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if usuario.rol == 'superadmin' %}bg-red-100 text-red-800 {% elif usuario.rol == 'admin' %}bg-blue-100 text-blue-800 {% elif usuario.rol == 'lector' %}bg-purple-100 text-purple-800 {% else %}bg-green-100 text-green-800{% endif %}"
            >
              {% if usuario.rol == 'superadmin' %}
              <i class="fas fa-crown mr-1"></i>
              {% elif usuario.rol == 'admin' %}
              <i class="fas fa-user-shield mr-1"></i>
              {% elif usuario.rol == 'lector' %}
              <i class="fas fa-eye mr-1"></i>
              {% else %}
              <i class="fas fa-user mr-1"></i>
              {% endif %} {{ usuario.rol|title }}
            </span>
          </td>
          <td class="px-2 text-right">
            <div class="relative" x-data="{ open: false }">
              <button
                @click="open = !open"
                class="p-2 rounded hover:bg-gray-100 group relative"
              >
                <i class="fas fa-ellipsis-v text-gray-400"></i>
              </button>

              <!-- Men√∫ desplegable de acciones -->
              <div
                x-show="open"
                @click.away="open = false"
                x-transition:enter="transition ease-out duration-100"
                x-transition:enter-start="transform opacity-0 scale-95"
                x-transition:enter-end="transform opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-75"
                x-transition:leave-start="transform opacity-100 scale-100"
                x-transition:leave-end="transform opacity-0 scale-95"
                class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 border border-gray-200"
              >
                <!-- Ver Carpetas -->
                <a
                  href="{{ url_for('listar_dropbox.ver_usuario_carpetas', usuario_id=usuario.id) }}"
                  class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600"
                >
                  <i class="fas fa-folder-open mr-3 text-blue-500"></i>
                  Ver Carpetas
                </a>

                <!-- Ver Historial -->
                <button
                  onclick="abrirModalHistorial({{ usuario.id }}, '{{ usuario.nombre or usuario.email }}')"
                  class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600"
                >
                  <i class="fas fa-history mr-3 text-green-500"></i>
                  Ver Historial
                </button>

                {% if current_user.puede_administrar() %}
                <!-- Separador -->
                <div class="border-t border-gray-100"></div>

                <!-- Editar Usuario -->
                <button
                  onclick="abrirModalEditar({{ usuario.id }}, '{{ usuario.nombre or usuario.email }}')"
                  class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600"
                >
                  <i class="fas fa-edit mr-3 text-yellow-500"></i>
                  Editar Usuario
                </button>

                <!-- Eliminar Usuario -->
                <button
                  onclick="confirmarEliminarUsuario({{ usuario.id }}, '{{ usuario.nombre or usuario.email }}')"
                  class="w-full flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50"
                >
                  <i class="fas fa-trash mr-3"></i>
                  Eliminar Usuario
                </button>
                {% endif %}
              </div>
            </div>
          </td>
        </tr>

        <!-- Tarjeta en m√≥vil -->
        <tr class="md:hidden">
          <td colspan="5" class="p-4">
            <div
              class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 mb-2 hover:bg-blue-50 transition"
            >
              <div class="flex items-center gap-3 mb-3">
                <span
                  class="w-10 h-10 rounded-full bg-blue-100 text-primary-dark font-bold text-lg flex items-center justify-center"
                >
                  {{ (usuario.nombre or usuario.email)[0]|upper }}
                </span>
                <div>
                  <div class="font-semibold text-gray-900 text-base">
                    {{ usuario.nombre_completo or usuario.email.split('@')[0] }}
                  </div>
                  <div class="text-xs text-gray-500">
                    @{{ usuario.email.split('@')[0] }}
                  </div>
                </div>
              </div>

              <div class="text-sm text-gray-700 space-y-2">
                <p><strong>Email:</strong> {{ usuario.email }}</p>
                <p>
                  <strong>Rol:</strong>
                  <span
                    class="inline-block px-2.5 py-0.5 rounded-full text-xs font-medium {% if usuario.rol == 'superadmin' %}bg-red-100 text-red-800 {% elif usuario.rol == 'admin' %}bg-blue-100 text-blue-800 {% elif usuario.rol == 'lector' %}bg-purple-100 text-purple-800 {% else %}bg-green-100 text-green-800{% endif %}"
                  >
                    {% if usuario.rol == 'superadmin' %}
                    <i class="fas fa-crown mr-1"></i>
                    {% elif usuario.rol == 'admin' %}
                    <i class="fas fa-user-shield mr-1"></i>
                    {% elif usuario.rol == 'lector' %}
                    <i class="fas fa-eye mr-1"></i>
                    {% else %}
                    <i class="fas fa-user mr-1"></i>
                    {% endif %} {{ usuario.rol|title }}
                  </span>
                </p>
                <p>
                  <strong>Carpetas:</strong>
                  <span class="text-lg font-bold text-green-600 ml-2">
                    {{ carpetas_por_usuario[usuario.id] }}
                  </span>
                  <span class="text-xs text-gray-500">carpetas</span>
                </p>
                <p>
                  <strong>Estado:</strong>
                  <span
                    class="inline-block px-2.5 py-0.5 rounded-full text-xs font-medium {% if usuario.activo %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}"
                  >
                    {% if usuario.activo %}
                    <i class="fas fa-check-circle mr-1"></i>Activo {% else %}
                    <i class="fas fa-times-circle mr-1"></i>Inactivo {% endif %}
                  </span>
                </p>
              </div>

              <!-- Acciones en m√≥vil -->
              <div class="flex flex-wrap gap-2 mt-4">
                <a
                  href="{{ url_for('listar_dropbox.ver_usuario_carpetas', usuario_id=usuario.id) }}"
                  class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition text-center"
                >
                  <i class="fas fa-folder-open mr-1"></i> Ver Carpetas
                </a>
                {% if current_user.puede_administrar() %}
                <button
                  class="flex-1 bg-gray-100 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition text-center"
                >
                  <i class="fas fa-cog mr-1"></i> Gestionar
                </button>
                {% endif %}
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <!-- Sin usuarios -->
    <div class="p-12 text-center">
      {% if current_user.es_lector() %}
      <div
        class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4"
      >
        <i class="fas fa-users text-gray-400 text-3xl"></i>
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">
        No hay clientes registrados
      </h3>
      <p class="text-gray-600">
        A√∫n no se han registrado clientes en el sistema.
      </p>
      {% else %}
      <i class="fas fa-users text-gray-300 text-6xl mb-4"></i>
      <h3 class="text-lg font-medium text-gray-900 mb-2">
        No hay usuarios en el sistema
      </h3>
      <p class="text-gray-500 mb-6">
        Crea el primer usuario para comenzar a gestionar carpetas.
      </p>
      {% if current_user.puede_administrar() %}
      <button
        class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
      >
        <i class="fas fa-user-plus mr-2"></i>
        Crear Usuario
      </button>
      {% endif %} {% endif %}
    </div>
    {% endif %}
  </div>
  </div>

<!-- Scripts para las acciones del men√∫ -->
<script>
  // Funci√≥n para abrir modal de historial
  function abrirModalHistorial(usuarioId, nombreUsuario) {
    // Por ahora mostrar un alert, pero se puede implementar un modal real
    alert(`Ver historial de ${nombreUsuario} (ID: ${usuarioId})`);
  }

  // Funci√≥n para abrir modal de editar usuario
  function abrirModalEditar(usuarioId, nombreUsuario) {
    // Por ahora mostrar un alert, pero se puede implementar un modal real
    alert(`Editar usuario ${nombreUsuario} (ID: ${usuarioId})`);
  }

  // Funci√≥n para confirmar eliminaci√≥n de usuario
  function confirmarEliminarUsuario(usuarioId, nombreUsuario) {
    if (confirm(`¬øEst√°s seguro de que quieres eliminar al usuario ${nombreUsuario}?`)) {
      // Aqu√≠ se puede implementar la l√≥gica de eliminaci√≥n
      alert(`Usuario ${nombreUsuario} eliminado (ID: ${usuarioId})`);
    }
  }
</script>
{% endblock %}
