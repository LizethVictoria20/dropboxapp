{% extends "base.html" %} {% block title %} {% if current_user.es_lector() %}
Clientes del Sistema {% else %} Carpetas de Usuarios {% endif %} {% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto px-6 py-8">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-3xl font-bold text-primary-dark">
        {% if current_user.es_lector() %} Clientes del Sistema {% else %}
        Carpetas de Usuarios {% endif %}
      </h1>
      <p class="text-gray-500 mt-1">
        {% if current_user.es_lector() %} Vista de clientes del sistema - Acceso
        de solo lectura {% else %} Vista general de todas las carpetas del
        sistema {% endif %}
      </p>
    </div>
    <div class="flex items-center space-x-3">
      {% if current_user.es_lector() %}
      <span
        class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800"
      >
        <i class="fas fa-eye mr-2"></i>
        Modo Lector
      </span>
      {% endif %}
      <a
        href="{{ url_for('main.dashboard_admin') }}"
        class="bg-blue-100 text-primary-dark rounded-lg px-4 py-2 font-medium hover:bg-blue-200 transition"
      >
        <i class="fas fa-arrow-left mr-2"></i>
        Volver al Dashboard
      </a>
    </div>
  </div>

  <!-- Informaci√≥n del Rol para Lectores -->
  {% if current_user.es_lector() %}
  <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
    <div class="flex items-center space-x-3 mb-3">
      <i class="fas fa-info-circle text-blue-600 text-xl"></i>
      <h3 class="text-lg font-medium text-blue-900">Modo Lector</h3>
    </div>
    <p class="text-blue-800 mb-4">
      Como usuario con rol de lector, puedes ver la informaci√≥n de los clientes
      pero no puedes realizar modificaciones. Esta es una vista de solo lectura
      para consulta y seguimiento.
    </p>
    <div class="flex flex-wrap gap-3">
      <span
        class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800"
      >
        <i class="fas fa-eye mr-2"></i>
        Solo Lectura
      </span>
      <span
        class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800"
      >
        <i class="fas fa-users mr-2"></i>
        Ver Clientes
      </span>
      <span
        class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-800"
      >
        <i class="fas fa-folder mr-2"></i>
        Ver Carpetas
      </span>
    </div>
  </div>
  {% endif %}

  <!-- Search -->
  <form
    method="get"
    action="{{ url_for('main.listar_carpetas') }}"
    class="mb-6"
  >
    <div>
      <input
        type="text"
        name="q"
        value="{{ request.args.get('q', '') }}"
        placeholder="üîç Buscar por nombre o email"
        class="w-[32rem] h-[3rem] text-sm px-4 py-3 rounded-xl border border-transparent focus:ring-2 focus:ring-blue-200 focus:outline-none placeholder-gray-400"
      />
    </div>
  </form>

  <!-- Tabla de usuarios -->
  <div
    class="bg-white rounded-2xl shadow-md border border-gray-100"
  >
    <div class="px-6 py-3 border-b bg-blue-50 flex items-center">
      <div class="flex items-center gap-2 text-primary-dark font-semibold">
        <i class="fas fa-users"></i>
        {% if current_user.es_lector() %} Clientes del Sistema {% else %}
        Usuarios y sus Carpetas {% endif %}
      </div>
      <span
        class="ml-auto text-xs font-bold bg-blue-100 text-primary-dark px-3 py-1 rounded-full"
      >
        {{ usuarios|length }} {% if current_user.es_lector() %} clientes {% else
        %} usuarios {% endif %}
      </span>
    </div>

    {% if usuarios %}
    <table class="min-w-full text-sm text-gray-700">
      <thead>
        <tr class="border-b text-gray-500">
          <th class="py-3 px-6 text-left">NOMBRE</th>
          <th class="py-3 px-2 text-left">EMAIL</th>
          <th class="py-3 px-2 text-left">ROL</th>
          <th class="py-3 px-2 text-right">ACCIONES</th>
        </tr>
      </thead>
      <tbody>
        {% for usuario in usuarios %}
        <!-- Fila de tabla en escritorio -->
        <tr
          class="border-b last:border-0 hover:bg-blue-50 transition hidden md:table-row"
        >
          <td class="flex items-center gap-3 py-3 px-6">
            <span
              class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-primary-dark font-bold text-lg"
            >
              {{ (usuario.nombre or usuario.email)[0]|upper }}
            </span>
            <div>
              <div class="font-semibold text-gray-900">
                {{ usuario.nombre_completo or usuario.email.split('@')[0] }}
              </div>
              <div class="text-xs text-gray-500">
                @{{ usuario.email.split('@')[0] }}
              </div>
            </div>
          </td>
          <td class="px-2">{{ usuario.email }}</td>
          <td class="px-2">
            <span
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if usuario.rol == 'superadmin' %}bg-red-100 text-red-800 {% elif usuario.rol == 'admin' %}bg-blue-100 text-blue-800 {% elif usuario.rol == 'lector' %}bg-purple-100 text-purple-800 {% else %}bg-green-100 text-green-800{% endif %}"
            >
              {% if usuario.rol == 'superadmin' %}
              <i class="fas fa-crown mr-1"></i>
              {% elif usuario.rol == 'admin' %}
              <i class="fas fa-user-shield mr-1"></i>
              {% elif usuario.rol == 'lector' %}
              <i class="fas fa-eye mr-1"></i>
              {% else %}
              <i class="fas fa-user mr-1"></i>
              {% endif %} {{ usuario.rol|title }}
            </span>
          </td>
          <td class="px-2 text-right">
            <div class="relative" x-data="{ open: false }">
              <button
                @click="open = !open"
                class="p-2 rounded hover:bg-gray-100 group relative"
              >
                <i class="fas fa-ellipsis-v text-gray-400"></i>
              </button>

              <!-- Men√∫ desplegable de acciones -->
              <div
                x-show="open"
                @click.away="open = false"
                x-transition:enter="transition ease-out duration-100"
                x-transition:enter-start="transform opacity-0 scale-95"
                x-transition:enter-end="transform opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-75"
                x-transition:leave-start="transform opacity-100 scale-100"
                x-transition:leave-end="transform opacity-0 scale-95"
                class="absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg z-50 border border-gray-200"
              >
                <!-- Ver Carpetas -->
                <a
                  href="{{ url_for('listar_dropbox.ver_usuario_carpetas', usuario_id=usuario.id) }}"
                  class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 whitespace-nowrap"
                >
                  <i class="fas fa-folder-open mr-3 text-blue-500"></i>
                  Ver Carpetas
                </a>

                <!-- Ver Historial -->
                <button
                  onclick="abrirModalHistorial({{ usuario.id }}, '{{ usuario.nombre or usuario.email }}')"
                  class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 whitespace-nowrap"
                >
                  <i class="fas fa-history mr-3 text-green-500"></i>
                  Ver Historial
                </button>

                {% if current_user.rol == 'lector' and current_user.lector_extra_permissions and 'editar_cliente' in current_user.lector_extra_permissions %}
                <!-- Editar Usuario (solo lector con permiso editar_cliente) -->
                <button
                  onclick="abrirModalEditar({{ usuario.id }}, '{{ usuario.nombre or usuario.email }}')"
                  class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 whitespace-nowrap"
                >
                  <i class="fas fa-user-edit mr-3 text-yellow-500"></i>
                  Editar Cliente
                </button>
                {% endif %}

                {% if current_user.puede_administrar() or
                current_user.puede_agregar_beneficiarios() %}
                <!-- Separador -->
                <div class="border-t border-gray-100"></div>

                <!-- Agregar Beneficiario -->
                <button
                  onclick="abrirModalBeneficiario({{ usuario.id }}, '{{ usuario.nombre or usuario.email }}')"
                  class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 whitespace-nowrap"
                >
                  <i class="fas fa-user-plus mr-3 text-purple-500"></i>
                  Agregar Beneficiario
                </button>
                {% endif %} {% if current_user.puede_administrar() %}
                <!-- Editar Usuario -->
                <button
                  onclick="abrirModalEditar({{ usuario.id }}, '{{ usuario.nombre or usuario.email }}')"
                  class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 whitespace-nowrap"
                >
                  <i class="fas fa-edit mr-3 text-yellow-500"></i>
                  Editar Usuario
                </button>

                <!-- Eliminar Usuario -->
                <button
                  onclick="confirmarEliminarUsuario({{ usuario.id }}, '{{ usuario.nombre or usuario.email }}')"
                  class="w-full flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50 whitespace-nowrap"
                >
                  <i class="fas fa-trash mr-3"></i>
                  Eliminar Usuario
                </button>
                {% endif %}
              </div>
            </div>
          </td>
        </tr>

        <!-- Tarjeta en m√≥vil -->
        <tr class="md:hidden">
          <td colspan="5" class="p-4">
            <div
              class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 mb-2 hover:bg-blue-50 transition"
            >
              <div class="flex items-center gap-3 mb-3">
                <span
                  class="w-10 h-10 rounded-full bg-blue-100 text-primary-dark font-bold text-lg flex items-center justify-center"
                >
                  {{ (usuario.nombre or usuario.email)[0]|upper }}
                </span>
                <div>
                  <div class="font-semibold text-gray-900 text-base">
                    {{ usuario.nombre_completo or usuario.email.split('@')[0] }}
                  </div>
                  <div class="text-xs text-gray-500">
                    @{{ usuario.email.split('@')[0] }}
                  </div>
                </div>
              </div>

              <div class="text-sm text-gray-700 space-y-2">
                <p><strong>Email:</strong> {{ usuario.email }}</p>
                <p>
                  <strong>Rol:</strong>
                  <span
                    class="inline-block px-2.5 py-0.5 rounded-full text-xs font-medium {% if usuario.rol == 'superadmin' %}bg-red-100 text-red-800 {% elif usuario.rol == 'admin' %}bg-blue-100 text-blue-800 {% elif usuario.rol == 'lector' %}bg-purple-100 text-purple-800 {% else %}bg-green-100 text-green-800{% endif %}"
                  >
                    {% if usuario.rol == 'superadmin' %}
                    <i class="fas fa-crown mr-1"></i>
                    {% elif usuario.rol == 'admin' %}
                    <i class="fas fa-user-shield mr-1"></i>
                    {% elif usuario.rol == 'lector' %}
                    <i class="fas fa-eye mr-1"></i>
                    {% else %}
                    <i class="fas fa-user mr-1"></i>
                    {% endif %} {{ usuario.rol|title }}
                  </span>
                </p>
                <p>
                  <strong>Carpetas:</strong>
                  <span class="text-lg font-bold text-green-600 ml-2">
                    {{ carpetas_por_usuario[usuario.id] }}
                  </span>
                  <span class="text-xs text-gray-500">carpetas</span>
                </p>
                <p>
                  <strong>Estado:</strong>
                  <span
                    class="inline-block px-2.5 py-0.5 rounded-full text-xs font-medium {% if usuario.activo %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}"
                  >
                    {% if usuario.activo %}
                    <i class="fas fa-check-circle mr-1"></i>Activo {% else %}
                    <i class="fas fa-times-circle mr-1"></i>Inactivo {% endif %}
                  </span>
                </p>
              </div>

              <!-- Acciones en m√≥vil -->
              <div class="flex flex-wrap gap-2 mt-4">
                <a
                  href="{{ url_for('listar_dropbox.ver_usuario_carpetas', usuario_id=usuario.id) }}"
                  class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition text-center"
                >
                  <i class="fas fa-folder-open mr-1"></i> Ver Carpetas
                </a>
                {% if current_user.puede_administrar() or
                current_user.puede_agregar_beneficiarios() %}
                <button
                  onclick="abrirModalBeneficiario({{ usuario.id }}, '{{ usuario.nombre or usuario.email }}')"
                  class="flex-1 bg-purple-100 text-purple-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-purple-200 transition text-center"
                >
                  <i class="fas fa-user-plus mr-1"></i> Agregar Beneficiario
                </button>
                {% endif %}
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <!-- Sin usuarios -->
    <div class="p-12 text-center">
      {% if current_user.es_lector() %}
      <div
        class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4"
      >
        <i class="fas fa-users text-gray-400 text-3xl"></i>
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">
        No hay clientes registrados
      </h3>
      <p class="text-gray-600">
        A√∫n no se han registrado clientes en el sistema.
      </p>
      {% else %}
      <i class="fas fa-users text-gray-300 text-6xl mb-4"></i>
      <h3 class="text-lg font-medium text-gray-900 mb-2">
        No hay usuarios en el sistema
      </h3>
      <p class="text-gray-500 mb-6">
        Crea el primer usuario para comenzar a gestionar carpetas.
      </p>
      {% if current_user.puede_administrar() %}
      <button
        class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
      >
        <i class="fas fa-user-plus mr-2"></i>
        Crear Usuario
      </button>
      {% endif %} {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<!-- Modal de Editar Usuario (reutilizado como en /usuarios) -->
<div
  id="editUserModal"
  tabindex="-1"
  aria-hidden="true"
  class="fixed inset-0 z-50 items-center justify-center hidden overflow-y-auto bg-black bg-opacity-75"
>
  <div class="relative w-full max-w-4xl p-4 max-h-full m-auto">
    <div id="modalContent" class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all">
      <!-- Encabezado del Modal -->
      <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
        <h3 class="text-xl font-bold font-montserrat text-text flex items-center" id="modal-title">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          Editar Cliente <span id="editing-user-name" class="ml-2"></span>
        </h3>
        <button type="button" class="text-gray-400 hover:text-gray-500 focus:outline-none" onclick="cerrarModalEditar()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Contenido del Modal -->
      <div class="max-h-[70vh] overflow-auto">
        <form id="editUserForm" action="{{ url_for('users.update_user') }}" method="POST">
          <input type="hidden" id="edit-user-id" name="user_id" />
          <div class="px-6 py-5 bg-gray-50">
            <div id="messageBox" class="message-box hidden" role="alert"></div>

            <!-- Tabs m√≠nimas: Info b√°sica, Seguridad, Roles -->
            <div class="border-b border-gray-200 mb-6 sticky top-0 bg-gray-50 z-10">
              <nav class="-mb-px flex space-x-8">
                <button type="button" class="whitespace-nowrap tab-button active border-primary text-primary font-medium border-b-2 py-3 px-1" data-tab="info-basica-tab">Informaci√≥n B√°sica</button>
                <button type="button" class="whitespace-nowrap tab-button text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent font-medium border-b-2 py-3 px-1" data-tab="contrasena-tab">Cambiar Contrase√±a</button>
                <button type="button" class="whitespace-nowrap tab-button text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent font-medium border-b-2 py-3 px-1" data-tab="roles-tab">Roles de Usuario</button>
              </nav>
            </div>

            <div class="tab-content">
              <!-- Info b√°sica -->
              <div id="info-basica-tab" class="tab-pane">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div class="space-y-2">
                    <label for="edit-email" class="block text-sm font-medium text-text">Email</label>
                    <input type="email" name="email" id="edit-email" class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary shadow-sm" placeholder="ejemplo@correo.com" required />
                  </div>
                  <div class="space-y-2">
                    <label for="edit-name" class="block text-sm font-medium text-text">Nombre</label>
                    <input type="text" name="nombre" id="edit-name" class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary shadow-sm" placeholder="Nombre" />
                  </div>
                  <div class="space-y-2">
                    <label for="edit-lastname" class="block text-sm font-medium text-text">Apellido</label>
                    <input type="text" name="apellido" id="edit-lastname" class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary shadow-sm" placeholder="Apellido" />
                  </div>
                  <div class="space-y-2">
                    <label for="edit-telephone" class="block text-sm font-medium text-text">Tel√©fono</label>
                    <input type="text" name="telefono" id="edit-telephone" class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary shadow-sm" placeholder="N√∫mero de tel√©fono" />
                  </div>
                </div>
              </div>

              <!-- Cambiar contrase√±a -->
              <div id="contrasena-tab" class="tab-pane hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div class="space-y-2">
                    <label for="edit-password" class="block text-sm font-medium text-text">Nueva Contrase√±a</label>
                    <input type="password" name="password" id="edit-password" class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary shadow-sm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                  </div>
                  <div class="space-y-2">
                    <label for="edit-password-confirm" class="block text-sm font-medium text-text">Confirmar Contrase√±a</label>
                    <input type="password" name="password_confirm" id="edit-password-confirm" class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary shadow-sm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                  </div>
                </div>
              </div>

              <!-- Roles -->
              <div id="roles-tab" class="tab-pane hidden">
                <div class="space-y-4">
                  <div class="space-y-2">
                    <label class="block text-sm font-medium text-text">Rol del Usuario</label>
                    <div class="bg-white border border-gray-200 rounded-lg">
                      <label class="role-option cursor-pointer block">
                        <input type="radio" name="rol" value="admin" class="sr-only" onchange="toggleLectorPermissions()" />
                        <div class="flex items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50">
                          <div class="flex items-center"><div class="w-4 h-4 border-2 border-gray-300 rounded-full mr-3"></div><span class="text-sm font-medium text-gray-900">Administrador</span></div>
                        </div>
                      </label>
                      <label class="role-option cursor-pointer block">
                        <input type="radio" name="rol" value="lector" class="sr-only" onchange="toggleLectorPermissions()" />
                        <div class="flex items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50">
                          <div class="flex items-center"><div class="w-4 h-4 border-2 border-gray-300 rounded-full mr-3"></div><span class="text-sm font-medium text-gray-900">Lector</span></div>
                        </div>
                      </label>
                      <label class="role-option cursor-pointer block">
                        <input type="radio" name="rol" value="superadmin" class="sr-only" onchange="toggleLectorPermissions()" />
                        <div class="flex items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50">
                          <div class="flex items-center"><div class="w-4 h-4 border-2 border-gray-300 rounded-full mr-3"></div><span class="text-sm font-medium text-gray-900">Superadmin</span></div>
                        </div>
                      </label>
                      <label class="role-option cursor-pointer block">
                        <input type="radio" name="rol" value="cliente" class="sr-only" onchange="toggleLectorPermissions()" />
                        <div class="flex items-center justify-between p-4 hover:bg-gray-50">
                          <div class="flex items-center"><div class="w-4 h-4 border-2 border-gray-300 rounded-full mr-3"></div><span class="text-sm font-medium text-gray-900">Cliente</span></div>
                        </div>
                      </label>
                    </div>
                  </div>

                  <!-- Permisos adicionales para Lector -->
                  <div id="editLectorPermissions" class="hidden bg-gray-50 border-b border-gray-100">
                    <div class="p-4">
                      <h4 class="text-sm font-medium text-gray-700 mb-3">Permisos Adicionales</h4>
                      <div class="space-y-3">
                        <label class="flex items-center"><input type="checkbox" name="puede_renombrar" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" /><span class="ml-2 text-sm text-gray-700">Renombrar archivos</span></label>
                        <label class="flex items-center"><input type="checkbox" name="puede_mover" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" /><span class="ml-2 text-sm text-gray-700">Mover archivos</span></label>
                        <label class="flex items-center"><input type="checkbox" name="puede_eliminar" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" /><span class="ml-2 text-sm text-gray-700">Eliminar archivos</span></label>
                        <label class="flex items-center"><input type="checkbox" name="puede_agregar_beneficiarios" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" /><span class="ml-2 text-sm text-gray-700">Agregar beneficiarios</span></label>
                        <label class="flex items-center"><input type="checkbox" name="puede_editar_cliente" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" /><span class="ml-2 text-sm text-gray-700">Editar Cliente</span></label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Botones de Acci√≥n -->
          <div class="px-6 py-4 bg-white border-t border-gray-100 flex justify-end gap-3">
            <button type="button" class="inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-text bg-white hover:bg-gray-50" onclick="cerrarModalEditar()">Cancelar</button>
            <button type="submit" class="inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary hover:bg-primary-light">Guardar Cambios</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Historial -->
<div id="modalHistorial" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-xl w-full max-w-3xl mx-4">
    <!-- Header del modal -->
    <div class="flex items-center justify-between p-6 border-b border-gray-200">
      <div>
        <h3 class="text-lg font-semibold text-gray-900">Historial de Actividad</h3>
        <p class="text-sm text-gray-600 mt-1">Para: <span id="nombreUsuarioHistorial" class="font-medium"></span></p>
      </div>
      <button onclick="cerrarModalHistorial()" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>

    <!-- Contenido -->
    <div class="p-6 overflow-y-auto max-h-[70vh]">
      <div id="contenidoHistorial" class="space-y-4">
        <!-- El contenido se cargar√° din√°micamente -->
      </div>
    </div>
  </div>
</div>

<!-- Modal para Agregar Beneficiario -->
<div
  id="modalBeneficiario"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
>
  <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4">
    <!-- Header del modal -->
    <div class="flex items-center justify-between p-6 border-b border-gray-200">
      <div>
        <h3 class="text-lg font-semibold text-gray-900">
          Agregar Beneficiario
        </h3>
        <p class="text-sm text-gray-600 mt-1">
          Para: <span id="nombreTitular" class="font-medium"></span>
        </p>
      </div>
      <button
        onclick="cerrarModalBeneficiario()"
        class="text-gray-400 hover:text-gray-600"
      >
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>

    <!-- Formulario -->
    <form id="formBeneficiario" class="p-6">
      <input type="hidden" id="titularId" name="titular_id" />

      <div class="space-y-4">
        <!-- Nombre -->
        <div>
          <label
            for="nombreBeneficiario"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Nombre completo <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="nombreBeneficiario"
            name="nombre"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="Ingresa el nombre completo"
          />
        </div>

        <!-- Email -->
        <div>
          <label
            for="emailBeneficiario"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Correo electr√≥nico <span class="text-red-500">*</span>
          </label>
          <input
            type="email"
            id="emailBeneficiario"
            name="email"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="ejemplo@correo.com"
          />
        </div>

        <!-- Fecha de nacimiento -->
        <div>
          <label
            for="fechaNacimiento"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Fecha de nacimiento
          </label>
          <input
            type="date"
            id="fechaNacimiento"
            name="fecha_nacimiento"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>
      </div>

      <!-- Mensaje de estado -->
      <div id="mensajeBeneficiario" class="hidden mt-4 p-3 rounded-lg"></div>

      <!-- Botones -->
      <div class="flex justify-end space-x-3 mt-6">
        <button
          type="button"
          onclick="cerrarModalBeneficiario()"
          class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
        >
          Cancelar
        </button>
        <button
          type="submit"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center"
        >
          <i class="fas fa-user-plus mr-2"></i>
          Agregar Beneficiario
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Scripts para las acciones del men√∫ -->
<script>
  // Funci√≥n para abrir modal de historial
  function abrirModalHistorial(usuarioId, nombreUsuario) {
    const modal = document.getElementById("modalHistorial");
    const nombreSpan = document.getElementById("nombreUsuarioHistorial");
    const contenido = document.getElementById("contenidoHistorial");

    if (!modal || !nombreSpan || !contenido) {
      alert("Error: No se pudo abrir el modal de historial.");
      return;
    }

    nombreSpan.textContent = nombreUsuario;
    contenido.innerHTML = '<p class="text-gray-500 text-center py-8">Cargando historial...</p>';
    modal.classList.remove("hidden");

    fetch(`/api/lectores/${usuarioId}/historial`, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
      .then(r => r.json())
      .then(data => {
        if (data && data.success) {
          const actividades = data.actividades || [];
          if (actividades.length) {
            contenido.innerHTML = actividades.map(a => `
              <div class="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
                <div class="w-2 h-2 rounded-full bg-blue-500 mt-2 flex-shrink-0"></div>
                <div class="flex-1">
                  <p class="text-sm font-medium text-gray-900">${a.accion || ''}</p>
                  <p class="text-sm text-gray-600">${a.descripcion || ''}</p>
                  <p class="text-xs text-gray-500">${a.fecha ? new Date(a.fecha).toLocaleString() : ''}</p>
                </div>
              </div>
            `).join('');
          } else {
            contenido.innerHTML = '<p class="text-gray-500 text-center py-8">No hay actividades registradas para este usuario.</p>';
          }
        } else {
          contenido.innerHTML = '<p class="text-red-500 text-center py-8">No se pudo cargar el historial.</p>';
        }
      })
      .catch(err => {
        console.error('Error cargando historial:', err);
        contenido.innerHTML = '<p class="text-red-500 text-center py-8">Error al cargar el historial.</p>';
      });
  }

  function cerrarModalHistorial() {
    const modal = document.getElementById("modalHistorial");
    if (modal) modal.classList.add("hidden");
  }

  // Funci√≥n para abrir modal de editar usuario (reutiliza el modal de edici√≥n existente)
  function abrirModalEditar(usuarioId, nombreUsuario) {
    if (typeof openEditModal === 'function') {
      openEditModal(usuarioId);
      return;
    }
    // Fallback simple: si no est√° cargada la funci√≥n, intentar cargar datos y mostrar modal local
    if (typeof window._openEditModalLocal === 'function') {
      window._openEditModalLocal(usuarioId);
      return;
    }
    alert('No se pudo abrir el modal de edici√≥n en esta vista. Actualiza la p√°gina e intenta de nuevo.');
  }

  // Funci√≥n para confirmar eliminaci√≥n de usuario
  function confirmarEliminarUsuario(usuarioId, nombreUsuario) {
    if (
      confirm(
        `¬øEst√°s seguro de que quieres eliminar al usuario ${nombreUsuario}?`
      )
    ) {
      // Aqu√≠ se puede implementar la l√≥gica de eliminaci√≥n
      alert(`Usuario ${nombreUsuario} eliminado (ID: ${usuarioId})`);
    }
  }

  // Funci√≥n para abrir modal de beneficiario
  function abrirModalBeneficiario(usuarioId, nombreUsuario) {
    console.log("Abriendo modal para usuario:", usuarioId, nombreUsuario);

    const titularIdInput = document.getElementById("titularId");
    const nombreTitularSpan = document.getElementById("nombreTitular");
    const modal = document.getElementById("modalBeneficiario");
    const form = document.getElementById("formBeneficiario");
    const mensajeDiv = document.getElementById("mensajeBeneficiario");

    if (
      !titularIdInput ||
      !nombreTitularSpan ||
      !modal ||
      !form ||
      !mensajeDiv
    ) {
      console.error("Elementos del modal no encontrados");
      alert(
        "Error: No se pudo abrir el modal. Recarga la p√°gina e intenta de nuevo."
      );
      return;
    }

    // Configurar datos del modal
    titularIdInput.value = usuarioId;
    nombreTitularSpan.textContent = nombreUsuario;

    // Limpiar formulario y mensajes
    form.reset();
    mensajeDiv.classList.add("hidden");
    mensajeDiv.innerHTML = "";

    // Mostrar modal
    modal.classList.remove("hidden");

    console.log("Modal abierto correctamente");
  }

  // Funci√≥n para cerrar modal de beneficiario
  function cerrarModalBeneficiario() {
    const modal = document.getElementById("modalBeneficiario");
    if (modal) {
      modal.classList.add("hidden");
      console.log("Modal cerrado");
    }
  }

  // Manejar env√≠o del formulario de beneficiario
  document.addEventListener("DOMContentLoaded", function () {
    const formBeneficiario = document.getElementById("formBeneficiario");
    if (formBeneficiario) {
      formBeneficiario.addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const mensajeDiv = document.getElementById("mensajeBeneficiario");

        // Mostrar estado de carga
        mensajeDiv.className = "mt-4 p-3 rounded-lg bg-blue-100 text-blue-700";
        mensajeDiv.innerHTML =
          '<i class="fas fa-spinner fa-spin mr-2"></i>Creando beneficiario...';
        mensajeDiv.classList.remove("hidden");

        // Enviar datos al servidor
        fetch("/users/crear_beneficiario", {
          method: "POST",
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData,
        })
          .then((response) => {
            console.log("Response status:", response.status);
            console.log("Response headers:", response.headers);

            if (!response.ok) {
              // Manejar errores espec√≠ficos
              if (response.status === 401) {
                throw new Error('No autenticado');
              } else if (response.status === 403) {
                throw new Error('Sin permisos');
              } else if (response.status === 500) {
                throw new Error('Error del servidor');
              } else {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
            }
            
            // Verificar el tipo de contenido
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
              throw new Error('Respuesta no es JSON v√°lido');
            }
            
            return response.json();
          })
          .then((data) => {
            console.log("Response data:", data);

            if (data.success) {
              // Si el beneficiario se cre√≥ exitosamente, cerrar modal inmediatamente y recargar
              console.log(
                "‚úÖ Beneficiario creado exitosamente, cerrando modal..."
              );
              cerrarModalBeneficiario();
              // Recargar la p√°gina para mostrar el nuevo beneficiario
              window.location.reload();
            } else {
              mensajeDiv.className =
                "mt-4 p-3 rounded-lg bg-red-100 text-red-700";
              mensajeDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${data.error || 'Error desconocido'}`;
              
              // Si hay redirecci√≥n sugerida, mostrarla
              if (data.redirect) {
                setTimeout(() => {
                  window.location.href = data.redirect;
                }, 2000);
              }
            }
          })
          .catch((error) => {
            console.error("Error completo:", error);
            mensajeDiv.className =
              "mt-4 p-3 rounded-lg bg-red-100 text-red-700";
            
            if (error.message === 'No autenticado') {
              mensajeDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Debes iniciar sesi√≥n para crear beneficiarios. Redirigiendo...';
              setTimeout(() => {
                window.location.href = '/auth/login';
              }, 2000);
            } else if (error.message === 'Sin permisos') {
              mensajeDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>No tienes permisos para crear beneficiarios.';
            } else if (error.message === 'Respuesta no es JSON v√°lido') {
              mensajeDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Error de comunicaci√≥n con el servidor. Verifica tu sesi√≥n.';
            } else {
              mensajeDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Error al crear beneficiarios. Intenta de nuevo.';
            }
            console.error("Error:", error);
          });
      });
    }

    // Cerrar modal al hacer clic fuera de √©l
    const modalBeneficiario = document.getElementById("modalBeneficiario");
    if (modalBeneficiario) {
      modalBeneficiario.addEventListener("click", function (e) {
        if (e.target === this) {
          cerrarModalBeneficiario();
        }
      });
    }
  });

  // Cerrar modal al hacer clic fuera de √©l
  document
    .getElementById("modalBeneficiario")
    .addEventListener("click", function (e) {
      if (e.target === this) {
        cerrarModalBeneficiario();
      }
    });

  // ===== Modal Editar Usuario (reutilizado) =====
  window.cerrarModalEditar = function () {
    const modal = document.getElementById('editUserModal');
    if (modal) modal.classList.add('hidden');
    const form = document.getElementById('editUserForm');
    if (form) form.reset();
  };

  window.toggleLectorPermissions = function () {
    const selectedRole = document.querySelector('input[name="rol"]:checked');
    const permisosDiv = document.getElementById('editLectorPermissions');
    if (!permisosDiv) return;
    if (selectedRole && selectedRole.value === 'lector') {
      permisosDiv.classList.remove('hidden');
    } else {
      permisosDiv.classList.add('hidden');
    }
  };

  window.openEditModal = function (userId) {
    // Cargar datos del usuario para editar (misma API que /usuarios)
    fetch(`/users/get_user/${userId}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const user = data.user;
          document.getElementById('edit-user-id').value = user.id;
          document.getElementById('edit-email').value = user.email || '';
          document.getElementById('edit-name').value = user.nombre || '';
          document.getElementById('edit-lastname').value = user.apellido || '';
          document.getElementById('edit-telephone').value = user.telefono || '';

          // Seleccionar rol
          const roleRadios = document.querySelectorAll('input[name="rol"]');
          roleRadios.forEach(r => r.checked = (r.value === (user.rol || 'usuario')));

          // Permisos lector
          const permisosDiv = document.getElementById('editLectorPermissions');
          const selectedRole = document.querySelector('input[name="rol"]:checked');
          if (selectedRole && selectedRole.value === 'lector') {
            permisosDiv.classList.remove('hidden');
          } else {
            permisosDiv.classList.add('hidden');
          }

          if (user.lector_extra_permissions) {
            try {
              const permisos = JSON.parse(user.lector_extra_permissions);
              document.querySelector('input[name="puede_renombrar"]').checked = permisos.includes('renombrar');
              document.querySelector('input[name="puede_mover"]').checked = permisos.includes('mover');
              document.querySelector('input[name="puede_eliminar"]').checked = permisos.includes('eliminar');
              document.querySelector('input[name="puede_agregar_beneficiarios"]').checked = permisos.includes('agregar_beneficiarios');
              const editarClienteInput = document.querySelector('input[name="puede_editar_cliente"]');
              if (editarClienteInput) editarClienteInput.checked = permisos.includes('editar_cliente');
            } catch (e) { /* noop */ }
          } else {
            // Limpiar checks
            ['puede_renombrar','puede_mover','puede_eliminar','puede_agregar_beneficiarios','puede_editar_cliente']
              .forEach(n => { const el = document.querySelector(`input[name="${n}"]`); if (el) el.checked = false; });
          }

          document.getElementById('editing-user-name').textContent = user.nombre || user.email;
          const modal = document.getElementById('editUserModal');
          if (modal) modal.classList.remove('hidden');

          // Inicializar tabs del modal de edici√≥n
          initEditUserModalTabs();
          // Mostrar por defecto Informaci√≥n B√°sica
          showEditUserTab('info-basica-tab');

          // Enlazar cambios de rol para alternar permisos de lector
          roleRadios.forEach(radio => {
            radio.addEventListener('change', toggleLectorPermissions);
          });
          
          // Enlazar submit para enviar como AJAX y permanecer en /listar_carpetas
          const form = document.getElementById('editUserForm');
          if (form) {
            form.addEventListener('submit', function(e){
              e.preventDefault();
              const fd = new FormData(form);
              fd.append('redirect_url', window.location.pathname);
              fetch(form.action, { method: 'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(r => r.json())
                .then(d => {
                  if (d && d.success) {
                    cerrarModalEditar();
                    // Si el backend env√≠a redirect, usarlo; de lo contrario recargar la p√°gina
                    if (d.redirect) {
                      window.location.href = d.redirect;
                    } else {
                      window.location.reload();
                    }
                  } else {
                    alert(d && d.error ? d.error : 'No se pudo actualizar el usuario');
                  }
                })
                .catch(() => alert('Error al actualizar el usuario'));
            }, { once: true });
          }
        } else {
          alert('Error al cargar los datos del usuario');
        }
      })
      .catch(() => alert('Error al cargar los datos del usuario'));
  };

  // Tabs del modal de edici√≥n (reutiliza misma l√≥gica que en /usuarios)
  function initEditUserModalTabs() {
    const modal = document.getElementById('editUserModal');
    if (!modal) return;
    const buttons = modal.querySelectorAll('.tab-button');
    const panes = modal.querySelectorAll('.tab-pane');

    buttons.forEach(btn => {
      btn.addEventListener('click', function () {
        const tabId = this.getAttribute('data-tab');
        showEditUserTab(tabId);
      });
    });

    // Helper para mostrar una pesta√±a
    window.showEditUserTab = function(tabId) {
      // Ocultar todas
      panes.forEach(p => p.classList.add('hidden'));
      // Desactivar todas
      buttons.forEach(b => {
        b.classList.remove('active', 'border-primary', 'text-primary');
        b.classList.add('border-transparent', 'text-gray-500');
      });
      // Activar seleccionada
      const activePane = modal.querySelector('#' + tabId);
      if (activePane) activePane.classList.remove('hidden');
      const activeBtn = Array.from(buttons).find(b => b.getAttribute('data-tab') === tabId);
      if (activeBtn) {
        activeBtn.classList.add('active', 'border-primary', 'text-primary');
        activeBtn.classList.remove('border-transparent', 'text-gray-500');
      }
    };
  }

  // Cerrar modal de historial al hacer clic fuera de √©l
  (function(){
    const modalHist = document.getElementById("modalHistorial");
    if (modalHist) {
      modalHist.addEventListener("click", function(e){
        if (e.target === this) cerrarModalHistorial();
      });
    }
  })();
</script>
{% endblock %}
