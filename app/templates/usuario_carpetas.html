{% extends "base.html" %} {% block title %}Carpetas de {% if beneficiario %}{{
beneficiario.nombre }}{% else %}{{ usuario.nombre or usuario.email }}{% endif
%}{% endblock %} {% block content %}
<div class="max-w-7xl mx-auto px-6 py-8">
  <!-- Header con informaci√≥n del usuario o beneficiario -->
  <div class="mb-6">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex items-center space-x-4 flex-col">
        <a
          href="{% if usuario_actual and usuario_actual.rol == 'lector' %}{{ url_for('main.listar_carpetas') }}{% else %}{{ url_for('usuarios.lista_usuarios') }}{% endif %}"
          class="inline-flex items-center text-gray-600 hover:text-gray-900 transition-colors"
        >
          <svg
            class="w-5 h-5 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            />
          </svg>
          Volver a carpetas
        </a>

        <div class="flex items-center space-x-3 mt-3">
          <div
            class="w-12 h-12 {% if beneficiario %}bg-green-100{% else %}bg-indigo-100{% endif %} rounded-full flex items-center justify-center"
          >
            <span
              class="{% if beneficiario %}text-green-600{% else %}text-indigo-600{% endif %} font-semibold text-lg"
            >
              {% if beneficiario %} {{ beneficiario.nombre[0].upper() }} {% else
              %} {{ (usuario.nombre or usuario.email)[0].upper() }} {% endif %}
            </span>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">
              {% if beneficiario %}
                {{ (beneficiario.nombre ~ ' ' ~ (beneficiario.lastname or ''))|trim }}
              {% else %}
                {% if usuario.nombre or usuario.apellido %}
                  {{ ((usuario.nombre or '') ~ ' ' ~ (usuario.apellido or ''))|trim }}
                {% else %}
                  {{ usuario.email.split('@')[0] }}
                {% endif %}
              {% endif %}
            </h1>
            <p class="text-gray-500">
              {% if beneficiario %} {{ beneficiario.email }}
              <span class="text-sm text-gray-400"
                >(Beneficiario de {{ beneficiario.titular.nombre or
                beneficiario.titular.email }})</span
              >
              {% else %} {{ usuario.email }} {% endif %}
            </p>
          </div>
        </div>
      </div>

      <div class="flex items-center flex-wrap gap-2 sm:gap-3">
        <!-- Bot√≥n Agregar Beneficiario -->
        {% if not beneficiario and (usuario_actual.puede_administrar() or
        usuario_actual.puede_agregar_beneficiarios()) %}
        <button
          onclick="abrirModalBeneficiario({{ usuario.id }}, '{{ usuario.nombre or usuario.email }}')"
          class="inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors"
        >
          <i class="fas fa-user-plus mr-2"></i>
          Agregar Beneficiario
        </button>
        {% endif %}

        <div class="text-sm text-gray-500">
          <span
            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if beneficiario %}bg-green-100 text-green-800{% else %}bg-blue-100 text-blue-800{% endif %}"
          >
            {% if beneficiario %}Beneficiario{% else %}{{ usuario.rol|capitalize
            }}{% endif %}
          </span>
          {% if usuario_actual.rol == 'lector' and usuario_actual.id !=
          usuario.id %}
          <span
            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 ml-2"
          >
            <i class="fas fa-eye mr-1"></i>
            Vista de Lector
          </span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Nota informativa para lectores -->
  {% if usuario_actual.rol == 'lector' and usuario_actual.id != usuario.id %}
  <div
  class="mb-6 {% if usuario_actual.puede_modificar_archivos() %}bg-green-50 border border-green-200{% else %}bg-blue-50 border border-blue-200{% endif %} rounded-xl p-4"
  >
    <div class="flex items-center flex-wrap gap-3">
      <i
        class="fas {% if usuario_actual.puede_modificar_archivos() %}fa-check-circle text-green-600{% else %}fa-info-circle text-blue-600{% endif %} text-xl"
      ></i>
      <div>
        <h3
          class="text-sm font-medium {% if usuario_actual.puede_modificar_archivos() %}text-green-900{% else %}text-blue-900{% endif %}"
        >
          {% if usuario_actual.puede_modificar_archivos() %} Modo Lector -
          Acceso con Permisos de Modificaci√≥n {% else %} Modo Lector - Acceso de
          Solo Lectura {% endif %}
        </h3>
        <p
          class="text-sm {% if usuario_actual.puede_modificar_archivos() %}text-green-800{% else %}text-blue-800{% endif %} mt-1"
        >
          Est√°s viendo las carpetas de
          <strong>{{ usuario.nombre or usuario.email }}</strong>
          {% if usuario_actual.puede_modificar_archivos() %} con permisos para
          modificar archivos y carpetas. {% else %} en modo de solo lectura.
          Puedes explorar todas las carpetas y archivos, pero no puedes realizar
          modificaciones. {% endif %}
        </p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Datos de estructuras de usuarios (necesario para openMoveModal) -->
  <script id="estructuras-usuarios-data" type="application/json">
    {{ estructuras_usuarios_json|safe }}
  </script>
  <script>
    window.CURRENT_USER_ROLE = '{{ usuario_actual.rol }}';
  </script>

  <!-- Contenedor de carpetas -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200">
    <div
      class="bg-gradient-to-r from-slate-50 to-gray-50 px-6 py-4 border-b border-gray-200"
    >
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-center flex-wrap gap-2 sm:gap-3">
          <svg
            class="w-6 h-6 text-indigo-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
            />
          </svg>
          <h2 class="text-lg font-semibold text-gray-900">
            Carpetas y Archivos
          </h2>
        </div>
        <div class="flex items-center space-x-3">
          <div class="text-sm text-gray-500">
            {% if estructuras_usuarios and usuario_id in estructuras_usuarios %}
            {% set estructura_usuario = estructuras_usuarios[usuario_id] %}
            {% if estructura_usuario._subcarpetas %}
            {{ estructura_usuario._subcarpetas|length }} carpeta(s)
            {% else %}
            Sin carpetas
            {% endif %}
            {% else %}
            Sin carpetas
            {% endif %}
          </div>
          {% if usuario_actual.rol == 'admin' or (usuario_actual.rol == 'lector' and usuario_actual.puede_modificar_archivos()) %}
          <button
            onclick="openCreateFolderModal('', '{{ usuario_id }}')"
            class="inline-flex items-center px-3 py-1.5 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Crear Carpeta
          </button>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="p-6 overflow-x-auto">
      {% if estructuras_usuarios and usuario_id in estructuras_usuarios %} {%
      set estructura_usuario = estructuras_usuarios[usuario_id] %} {% if
      estructura_usuario._subcarpetas or estructura_usuario._archivos %} {%
      import "tree_macros.html" as macros with context %} {{ macros.render_tree_flat(estructura_usuario, '', usuario_id, usuario_actual, folders_por_ruta, usuario.email) }}
 {% else %}
      <div class="text-center py-12">
        <svg
          class="w-16 h-16 text-gray-400 mx-auto mb-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
          />
        </svg>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No hay carpetas</h3>
        <p class="text-gray-500 mb-4">
          {% if beneficiario %} Este beneficiario a√∫n no tiene carpetas creadas.
          {% else %} Este usuario a√∫n no tiene carpetas creadas. {% endif %}
        </p>
        {% if usuario_actual.rol == 'admin' %}
        <p class="text-sm text-gray-400">
          Las carpetas se crear√°n autom√°ticamente cuando se suban archivos.
        </p>
        <button
          onclick="openUploadModal('', '{{ usuario_id }}')"
          class="inline-flex items-center px-4 py-2 mt-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        >
          <i class="fas fa-upload mr-2"></i>
          Subir archivo
        </button>
        {% endif %}
      </div>
      {% endif %} {% else %}
      <div class="text-center py-12">
        <svg
          class="w-16 h-16 text-gray-400 mx-auto mb-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
          />
        </svg>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No hay carpetas</h3>
        <p class="text-gray-500 mb-4">
          {% if beneficiario %} Este beneficiario a√∫n no tiene carpetas creadas.
          {% else %} Este usuario a√∫n no tiene carpetas creadas. {% endif %}
        </p>
        {% if usuario_actual.rol == 'admin' %}
        <p class="text-sm text-gray-400">
          Las carpetas se crear√°n autom√°ticamente cuando se suban archivos.
        </p>
        <button
          onclick="openUploadModal('', '{{ usuario_id }}')"
          class="inline-flex items-center px-4 py-2 mt-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        >
          <i class="fas fa-upload mr-2"></i>
          Subir archivo
        </button>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal Comentarios (igual que en carpetas_dropbox) -->
<div id="commentsModal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50" onclick="if (event.target === this) closeCommentsModal()">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-auto mt-20 overflow-hidden">
    <div class="flex items-center justify-between p-4 border-b">
      <h3 class="text-lg font-semibold">Comentarios</h3>
      <button onclick="closeCommentsModal()" class="text-gray-500 hover:text-gray-700">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-4">
      <div id="commentsList" class="space-y-3 max-h-64 overflow-y-auto"></div>
      {% if usuario_actual and (usuario_actual.rol == 'admin' or usuario_actual.rol == 'superadmin') %}
      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Nuevo comentario</label>
        <textarea id="newCommentText" class="w-full border rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Escribe tu comentario..."></textarea>
        <div class="mt-3 flex justify-end">
          <button id="sendCommentBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Enviar</button>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  <input type="hidden" id="commentsPath" value=""/>
  <input type="hidden" id="commentsTipo" value="archivo"/>
  <script>
    async function fetchJSON(url, options={}) {
      const res = await fetch(url, options);
      if (!res.ok) throw new Error('Error de red');
      return res.json();
    }
    function openCommentsModal(path, tipo){
      const modal = document.getElementById('commentsModal');
      document.getElementById('commentsPath').value = path;
      document.getElementById('commentsTipo').value = tipo || 'archivo';
      modal.classList.remove('hidden');
      loadComments();
    }
    function closeCommentsModal(){
      document.getElementById('commentsModal').classList.add('hidden');
      document.getElementById('commentsList').innerHTML = '';
      const txt = document.getElementById('newCommentText');
      if (txt) txt.value = '';
    }
    async function loadComments(){
      const path = document.getElementById('commentsPath').value;
      const list = document.getElementById('commentsList');
      list.innerHTML = '<div class="text-sm text-gray-500">Cargando...</div>';
      try{
        const res = await fetch(`{{ url_for('listar_dropbox.listar_comentarios') }}?path=${encodeURIComponent(path)}`);
        let data = null;
        if (res.ok) {
          try { data = await res.json(); } catch (e) { data = { success: true, comentarios: [] }; }
        }
        if (!res.ok || !data || data.success === false) {
          list.innerHTML = '<div class="text-sm text-gray-500">A√∫n no hay comentarios</div>';
          return;
        }
        const comentarios = Array.isArray(data.comentarios) ? data.comentarios : [];
        if (comentarios.length === 0){
          list.innerHTML = '<div class="text-sm text-gray-500">A√∫n no hay comentarios</div>';
          return;
        }
        list.innerHTML = comentarios.map(c => {
          const fecha = new Date(c.fecha_creacion).toLocaleDateString('es-ES');
          return `
            <div class=\"border rounded-md p-3 bg-gray-50\">
              <div class=\"text-xs text-gray-500 mb-1\">${c.usuario} ‚Ä¢ ${fecha}</div>
              <div class=\"text-sm text-gray-800 whitespace-pre-wrap\">${c.contenido}</div>
            </div>
          `;
        }).join('');
      }catch(e){
        list.innerHTML = '<div class="text-sm text-gray-500">A√∫n no hay comentarios</div>';
      }
    }
    {% if usuario_actual and (usuario_actual.rol == 'admin' or usuario_actual.rol == 'superadmin') %}
    document.addEventListener('click', function(e){
      if (e.target && e.target.id === 'sendCommentBtn'){
        (async () => {
          const path = document.getElementById('commentsPath').value;
          const tipo = document.getElementById('commentsTipo').value;
          const txt = document.getElementById('newCommentText');
          const contenido = (txt && txt.value || '').trim();
          if(!contenido){
            alert('Escribe un comentario');
            return;
          }
          try{
            const data = await fetchJSON(`{{ url_for('listar_dropbox.crear_comentario') }}`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ path, tipo, contenido })
            });
            if(data.success){
              if (txt) txt.value = '';
              await loadComments();
            } else {
              alert('No se pudo enviar el comentario');
            }
          }catch(err){
            alert('Error de red al enviar el comentario');
          }
        })();
      }
    });
    {% endif %}
  </script>
</div>
<!-- Modal para cambiar estado de archivo -->
<div id="statusModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900">Cambiar estado del archivo</h3>
      <button onclick="closeStatusModal()" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <p id="statusFileName" class="text-sm text-gray-600 mb-4"></p>
    <div class="space-y-3">
      <label class="flex items-center space-x-3">
        <input type="radio" name="estadoArchivo" value="en_revision" class="text-blue-600" checked />
        <span>En proceso de revisi√≥n</span>
      </label>
      <label class="flex items-center space-x-3">
        <input type="radio" name="estadoArchivo" value="validado" class="text-green-600" />
        <span>Validado</span>
      </label>
      <label class="flex items-center space-x-3">
        <input type="radio" name="estadoArchivo" value="rechazado" class="text-red-600" />
        <span>Rechazado</span>
      </label>
    </div>
    <div class="flex justify-end space-x-3 mt-6">
      <button onclick="closeStatusModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button>
      <button onclick="saveStatus()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Guardar</button>
    </div>
  </div>
  <input type="hidden" id="statusFilePath" />
  <input type="hidden" id="statusFileIdForBadge" />
</div>
<!-- Modal para crear carpeta -->
<div
  id="createFolderModal"
  class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50"
>
  <div
    class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
  >
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Crear nueva carpeta</h3>
        <button
          onclick="closeModal('createFolderModal')"
          class="text-gray-400 hover:text-gray-600"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>
      <form
        id="createFolderForm"
        action="{{ url_for('listar_dropbox.crear_carpeta') }}"
        method="post"
      >
        <input type="hidden" id="createFolderParent" name="padre" value="" />
        <input
          type="hidden"
          id="createFolderUsuarioId"
          name="usuario_id"
          value="{{ usuario_id }}"
        />
        <div class="mb-4">
          <label
            for="folderName"
            class="block text-sm font-medium text-gray-700 mb-2"
            >Nombre de la carpeta</label
          >
          <input
            type="text"
            id="folderName"
            name="nombre"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          />
        </div>
        <div class="mb-4">
          <label
            for="folderVisibility"
            class="block text-sm font-medium text-gray-700 mb-2"
            >Visibilidad</label
          >
          <select
            id="folderVisibility"
            name="es_publica"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          >
            <option value="true">P√∫blica</option>
            <option value="false">Privada</option>
          </select>
        </div>
        <div class="flex justify-end space-x-3">
          <button
            type="button"
            onclick="closeModal('createFolderModal')"
            class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors"
          >
            Crear carpeta
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para subir archivo -->
<div
  id="uploadFileModal"
  class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50"
>
  <div
    class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
  >
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Subir archivo</h3>
        <button
          onclick="closeModal('uploadFileModal')"
          class="text-gray-400 hover:text-gray-600"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>
      <form
        id="uploadFileForm"
        action="{{ url_for('listar_dropbox.subir_archivo_rapido') }}"
        method="post"
        enctype="multipart/form-data"
      >
        <input
          type="hidden"
          name="usuario_id"
          value="user-{{ usuario_id|string }}"
        />
        <div class="mb-4">
          <label
            for="fileInput"
            class="block text-sm font-medium text-gray-700 mb-2"
            >Seleccionar archivo</label
          >
          <input
            type="file"
            id="fileInput"
            name="archivo"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          />
        </div>
        <div class="flex justify-end space-x-3">
          <button
            type="button"
            onclick="closeModal('uploadFileModal')"
            class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
          >
            Subir archivo
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para renombrar archivo -->
<div
  id="renameModal"
  class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50"
>
  <div
    class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
  >
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Renombrar archivo</h3>
        <button
          onclick="closeModal('renameModal')"
          class="text-gray-400 hover:text-gray-600"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>
      <form
        id="renameForm"
        action="{{ url_for('listar_dropbox.renombrar_archivo') }}"
        method="post"
      >
        <input type="hidden" name="usuario_id" value="{{ usuario_id }}" />
        <input
          type="hidden"
          name="archivo_nombre_actual"
          id="renameArchivoNombreActual"
        />
        <input type="hidden" name="carpeta_actual" id="renameCarpetaActual" />
        <!-- Elemento adicional para compatibilidad con openRenameModal -->
        <input type="hidden" id="renameUsuarioId" value="{{ usuario_id }}" />
        <!-- Campo oculto para preservar la extensi√≥n del archivo -->
        <input type="hidden" id="archivoExtension" name="archivo_extension" />
        <div class="mb-4">
          <label
            for="newName"
            class="block text-sm font-medium text-gray-700 mb-2"
            >Nuevo nombre
            <span class="text-xs text-gray-500"
              >(la extensi√≥n se preservar√° autom√°ticamente)</span
            ></label
          >
          <input
            type="text"
            id="newName"
            name="nuevo_nombre"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          />
          <!-- Elemento adicional para compatibilidad con openRenameModal -->
          <input type="text" id="nuevoNombre" style="display: none" />
        </div>
        <div class="flex justify-end space-x-3">
          <button
            type="button"
            onclick="closeModal('renameModal')"
            class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
          >
            Renombrar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Confirmaci√≥n de Eliminaci√≥n -->
<div
  id="deleteConfirmModal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center"
>
  <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
    <div class="flex items-center mb-4">
      <div
        class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4"
      >
        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
      </div>
      <div>
        <h3 class="text-lg font-semibold text-gray-900">
          Confirmar Eliminaci√≥n
        </h3>
        <p class="text-sm text-red-600">Esta acci√≥n no se puede deshacer</p>
      </div>
    </div>

    <div class="mb-6">
      <p class="text-gray-700 mb-2">
        ¬øEst√°s seguro de que quieres eliminar
        <strong id="deleteItemName" class="text-red-600"></strong>?
      </p>
      <p class="text-sm text-gray-500" id="deleteItemDescription"></p>
    </div>

    <form id="deleteConfirmForm" method="post">
      <input type="hidden" name="usuario_id" id="deleteUsuarioId" />
      <input type="hidden" name="carpeta_actual" id="deleteCarpetaActual" />
      <input type="hidden" name="item_nombre" id="deleteItemNombre" />
      <input type="hidden" name="item_tipo" id="deleteItemTipo" />

      <div class="flex gap-3">
        <button
          type="button"
          onclick="cerrarModalEliminacion()"
          class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition"
        >
          Cancelar
        </button>
        <button
          type="submit"
          class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
        >
          Eliminar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para renombrar carpeta -->
<div
  id="renameFolderModal"
  class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50"
>
  <div
    class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
  >
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Renombrar carpeta</h3>
        <button
          onclick="closeModal('renameFolderModal')"
          class="text-gray-400 hover:text-gray-600"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>
      <form
        id="renameFolderForm"
        action="{{ url_for('listar_dropbox.renombrar_carpeta') }}"
        method="post"
      >
        <input type="hidden" name="usuario_id" value="{{ usuario_id }}" />
        <input
          type="hidden"
          name="carpeta_nombre_actual"
          id="renameCarpetaNombreActual"
        />
        <input type="hidden" name="carpeta_padre" id="renameCarpetaPadre" />
        <input type="hidden" name="redirect_url" value="{{ request.url }}" />
        <div class="mb-4">
          <label
            for="newFolderName"
            class="block text-sm font-medium text-gray-700 mb-2"
            >Nuevo nombre</label
          >
          <input
            type="text"
            id="newFolderName"
            name="nuevo_nombre"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          />
        </div>
        <div class="flex justify-end space-x-3">
          <button
            type="button"
            onclick="closeModal('renameFolderModal')"
            class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
          >
            Renombrar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para mover archivo -->
<div
  id="moveModal"
  class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 p-4"
>
  <div
    class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[95vh] min-h-[400px]"
  >
    <!-- Header fijo -->
    <div
      class="flex items-center justify-between p-6 border-b border-gray-200 flex-shrink-0"
    >
      <div class="flex items-center space-x-3">
        <div
          class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center"
        >
          <svg
            class="w-5 h-5 text-amber-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"
            />
          </svg>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-gray-900">Mover archivo</h3>
          <p class="text-sm text-gray-500">
            Archivo: <span id="moveFileName" class="font-medium"></span>
          </p>
        </div>
      </div>
      <button
        onclick="closeMoveModal()"
        class="text-gray-400 hover:text-gray-600 transition-colors duration-200"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>

    <!-- Contenido con scroll -->
    <div class="flex-1 overflow-y-auto">
      <form
        id="moveForm"
        method="post"
        action="{{ url_for('listar_dropbox.mover_archivo_modal') }}"
        class="flex flex-col h-full"
      >
        <input type="hidden" name="archivo_nombre" id="moveArchivoNombre" />
        <input type="hidden" name="carpeta_actual" id="moveCarpetaActual" />
        <input type="hidden" name="usuario_id" value="{{ usuario.id }}" />
        <input type="hidden" name="redirect_url" value="{{ request.url }}" />

        <div class="p-6">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-3"
              >Selecciona carpeta destino</label
            >
            <div
              id="destinoTree"
              class="border border-gray-300 rounded-lg bg-gray-50 p-4 min-h-[200px] max-h-[400px] overflow-y-auto"
            >
              <!-- Aqu√≠ se renderiza el √°rbol de carpetas destino v√≠a JS -->
            </div>
            <input
              type="hidden"
              name="nueva_carpeta"
              id="nuevaCarpetaSeleccionada"
              required
            />
            <div
              id="selectedFolder"
              class="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg hidden"
            >
              <div class="flex items-center">
                <svg
                  class="w-4 h-4 text-green-600 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                <span class="text-green-800 text-sm font-medium"></span>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Footer fijo -->
    <div
      class="flex justify-end space-x-3 p-6 border-t border-gray-200 bg-gray-50 flex-shrink-0"
    >
      <button
        type="button"
        onclick="closeMoveModal()"
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors duration-200"
      >
        Cancelar
      </button>
      <button
        id="moveSubmitButton"
        type="submit"
        form="moveForm"
        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed"
        disabled
      >
        Mover archivo
      </button>
    </div>
  </div>
</div>

<!-- Modal para visualizaci√≥n de archivos -->
<div
  id="viewerModal"
  class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center"
>
  <div
    class="bg-white rounded-xl shadow-2xl w-full max-w-6xl mx-4 max-h-[90vh] overflow-hidden"
  >
    <div class="flex items-center justify-between p-6 border-b border-gray-200">
      <div class="flex items-center space-x-3">
        <div
          class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center"
        >
          <svg
            class="w-5 h-5 text-blue-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
            />
          </svg>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-gray-900">
            Vista previa del archivo
          </h3>
          <p class="text-sm text-gray-500">
            Archivo: <span id="viewerFileName" class="font-medium"></span>
          </p>
        </div>
      </div>
      <button
        onclick="closePreviewModal()"
        class="text-gray-400 hover:text-gray-600 transition-colors duration-200"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>

    <div class="flex-1 overflow-hidden">
      <div
        id="viewerContent"
        class="w-full h-full flex items-center justify-center bg-gray-50"
      >
        <!-- El contenido del archivo se cargar√° aqu√≠ -->
      </div>
    </div>
  </div>
</div>

<!-- Elemento oculto para almacenar emails de usuarios -->
<script id="usuarios-emails-data" type="application/json">
  {
    "{{ usuario.id }}": "{{ usuario.email }}"
  }
</script>

<!-- Script para definir las funciones necesarias ANTES de openMoveModal -->
<script>
  // Definir toggleFolderMenu inmediatamente para que est√© disponible
  window.toggleFolderMenu = function (menuId, event) {
    console.log("üîß toggleFolderMenu (USUARIO_CARPETAS) llamado con:", {
      menuId,
      event,
    });
    event.stopPropagation();

    const menu = document.getElementById(menuId);
    console.log("üîß Elemento del men√∫ de carpeta encontrado:", menu);

    if (menu) {
      // Ocultar todos los men√∫s primero
      document.querySelectorAll('[id^="folder-menu-"]').forEach((m) => {
        m.classList.add("hidden");
      });

      if (menu.classList.contains("hidden")) {
        // Posicionar el men√∫ cerca del bot√≥n
        const button = event.currentTarget;
        const rect = button.getBoundingClientRect();
        console.log("üîß Posici√≥n del bot√≥n de carpeta:", rect);

        // Calcular posici√≥n del men√∫
        const menuWidth = 192; // w-48 = 12rem = 192px
        const menuHeight = menu.offsetHeight;

        // Posicionar el men√∫ a la derecha del bot√≥n
        let left = rect.right - menuWidth;
        let top = rect.bottom + 5;

        // Asegurar que el men√∫ no se salga de la pantalla
        if (left < 0) left = 0;
        if (top + menuHeight > window.innerHeight) {
          top = rect.top - menuHeight - 5;
        }

        menu.style.position = "fixed";
        menu.style.top = top + "px";
        menu.style.left = left + "px";
        menu.style.zIndex = "99999";

        menu.classList.remove("hidden");
        console.log("üîß Men√∫ de carpeta abierto:", menuId, "en posici√≥n:", {
          top,
          left,
        });
      } else {
        menu.classList.add("hidden");
        console.log("üîß Men√∫ de carpeta cerrado:", menuId);
      }
    } else {
      console.error("‚ùå Men√∫ de carpeta no encontrado:", menuId);
      console.log("üîß Elementos con 'folder-menu' en el DOM:");
      document.querySelectorAll('[id^="folder-menu"]').forEach((el) => {
        console.log("-", el.id);
      });
    }
  };

  console.log("‚úÖ toggleFolderMenu definida globalmente en usuario_carpetas.html");

  // Definir hideAllMenus localmente para asegurar disponibilidad
  window.hideAllMenus = function () {
    console.log("üîß hideAllMenus (usuario_carpetas) ejecut√°ndose...");
    // Ocultar todos los men√∫s de carpetas
    document.querySelectorAll('[id^="folder-menu-"]').forEach((menu) => {
      menu.classList.add("hidden");
    });
    // Ocultar todos los men√∫s de archivos
    document.querySelectorAll('[id^="file-menu-"]').forEach((menu) => {
      menu.classList.add("hidden");
    });
    console.log("üîß Todos los men√∫s ocultados desde usuario_carpetas.html");
  };

  // Definir openRenameModal para que est√© disponible
  window.openRenameModal = function (
    archivo,
    carpetaActual,
    usuarioId,
    tipo
  ) {
    console.log("openRenameModal (usuario_carpetas) llamado con:", {
      archivo,
      carpetaActual,
      usuarioId,
      tipo,
    });

    // Usar el tipo pasado como par√°metro en lugar de adivinar
    const isFolder = tipo === "carpeta";

    console.log("An√°lisis:", {
      archivo,
      isFolder,
    });

    if (isFolder) {
      // Renombrar carpeta
      console.log("Abriendo modal de carpeta");
      document.getElementById("renameFolderModal").classList.remove("hidden");
      document.getElementById("renameCarpetaNombreActual").value = archivo;
      document.getElementById("renameCarpetaPadre").value = carpetaActual;
      document.getElementById("newFolderName").value = archivo;
    } else {
      // Renombrar archivo
      console.log("Abriendo modal de archivo");
      document.getElementById("renameModal").classList.remove("hidden");
      document.getElementById("renameArchivoNombreActual").value = archivo;
      document.getElementById("renameCarpetaActual").value = carpetaActual;

      // Intentar establecer usuario_id si el elemento existe
      const renameUsuarioIdElement =
        document.getElementById("renameUsuarioId");
      if (renameUsuarioIdElement) {
        renameUsuarioIdElement.value = usuarioId;
      }

      // Establecer el nombre del archivo preservando la extensi√≥n
      const nuevoNombreElement = document.getElementById("nuevoNombre");
      const newNameElement = document.getElementById("newName");

      if (nuevoNombreElement) {
        nuevoNombreElement.value = archivo;
      }

            if (newNameElement) {
        // Separar el nombre y la extensi√≥n
        const lastDotIndex = archivo.lastIndexOf('.');
        if (lastDotIndex !== -1) {
          const nombreSinExtension = archivo.substring(0, lastDotIndex);
          const extension = archivo.substring(lastDotIndex);

          // Establecer solo el nombre sin extensi√≥n en el campo visible
          newNameElement.value = nombreSinExtension;

          // Guardar la extensi√≥n en un campo oculto para preservarla
          const extensionInput = document.getElementById("archivoExtension");
          if (!extensionInput) {
            // Crear el campo si no existe
            const hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.id = "archivoExtension";
            hiddenInput.name = "archivo_extension";
            hiddenInput.value = extension;
            document.getElementById("renameForm").appendChild(hiddenInput);
          } else {
            extensionInput.value = extension;
          }

          // Mostrar informaci√≥n sobre la extensi√≥n que se preservar√°
          console.log(`‚úÖ Extensi√≥n preservada: ${extension}`);
        } else {
          // Si no hay extensi√≥n, usar el nombre completo
          newNameElement.value = archivo;
          console.log("‚ÑπÔ∏è Archivo sin extensi√≥n detectado");
        }
      }
    }
  };

  // Definir confirmarEliminarCarpeta para que est√© disponible
  window.confirmarEliminarCarpeta = function (
    carpeta,
    carpetaPadre,
    usuarioId
  ) {
    console.log("üîß confirmarEliminarCarpeta (usuario_carpetas) llamado con:", {
      carpeta,
      carpetaPadre,
      usuarioId,
    });

    // Configurar el modal de confirmaci√≥n
    const modal = document.getElementById("deleteConfirmModal");
    const itemName = document.getElementById("deleteItemName");
    const itemDescription = document.getElementById("deleteItemDescription");
    const form = document.getElementById("deleteConfirmForm");
    const usuarioIdInput = document.getElementById("deleteUsuarioId");
    const carpetaActualInput = document.getElementById("deleteCarpetaActual");
    const itemNombreInput = document.getElementById("deleteItemNombre");
    const itemTipoInput = document.getElementById("deleteItemTipo");

    if (!modal || !itemName || !itemDescription || !form) {
      console.error("‚ùå Elementos del modal de eliminaci√≥n no encontrados");
      alert(
        "Error: No se pudo abrir el modal de confirmaci√≥n. Recarga la p√°gina e intenta de nuevo."
      );
      return;
    }

    // Configurar el contenido del modal
    itemName.textContent = `"${carpeta}"`;
    itemDescription.textContent =
      "Esta carpeta y todo su contenido ser√°n eliminados permanentemente de Dropbox y no se podr√°n recuperar.";

    // Configurar el formulario
    usuarioIdInput.value = usuarioId;
    carpetaActualInput.value = carpetaPadre;
    itemNombreInput.value = carpeta;
    itemTipoInput.value = "carpeta";

    // Configurar la acci√≥n del formulario
    form.action = '{{ url_for("listar_dropbox.eliminar_carpeta") }}';

    // Ocultar todos los men√∫s antes de mostrar el modal
    window.hideAllMenus();

    // Agregar campo de redirecci√≥n al formulario
    const redirectInput = document.createElement('input');
    redirectInput.type = 'hidden';
    redirectInput.name = 'redirect_url';
    redirectInput.value = window.location.href;
    form.appendChild(redirectInput);

    // Mostrar el modal
    modal.classList.remove("hidden");
    console.log("‚úÖ Modal de eliminaci√≥n de carpeta abierto");
  };

  // Definir confirmarOcultarCarpeta para que est√© disponible
  window.confirmarOcultarCarpeta = function (
    carpeta,
    carpetaPadre,
    usuarioId
  ) {
    console.log("üîß confirmarOcultarCarpeta (usuario_carpetas) llamado con:", {
      carpeta,
      carpetaPadre,
      usuarioId,
    });

    // Configurar el modal de confirmaci√≥n
    const modal = document.getElementById("deleteConfirmModal");
    const itemName = document.getElementById("deleteItemName");
    const itemDescription = document.getElementById("deleteItemDescription");
    const form = document.getElementById("deleteConfirmForm");
    const usuarioIdInput = document.getElementById("deleteUsuarioId");
    const carpetaActualInput = document.getElementById("deleteCarpetaActual");
    const itemNombreInput = document.getElementById("deleteItemNombre");
    const itemTipoInput = document.getElementById("deleteItemTipo");

    if (!modal || !itemName || !itemDescription || !form) {
      console.error("‚ùå Elementos del modal de eliminaci√≥n no encontrados");
      alert(
        "Error: No se pudo abrir el modal de confirmaci√≥n. Recarga la p√°gina e intenta de nuevo."
      );
      return;
    }

    // Configurar el contenido del modal
    itemName.textContent = `"${carpeta}"`;
    itemDescription.textContent =
      "Esta carpeta ser√° ocultada de la interfaz pero permanecer√° en Dropbox.";

    // Configurar el formulario
    usuarioIdInput.value = usuarioId;
    carpetaActualInput.value = carpetaPadre;
    itemNombreInput.value = carpeta;
    itemTipoInput.value = "carpeta";

    // Configurar la acci√≥n del formulario para ocultar
    form.action = '{{ url_for("listar_dropbox.ocultar_carpeta") }}';

    // Ocultar todos los men√∫s antes de mostrar el modal
    window.hideAllMenus();

    // Agregar campo de redirecci√≥n al formulario
    const redirectInput = document.createElement('input');
    redirectInput.type = 'hidden';
    redirectInput.name = 'redirect_url';
    redirectInput.value = window.location.href;
    form.appendChild(redirectInput);

    // Mostrar el modal
    modal.classList.remove("hidden");
    console.log("‚úÖ Modal de ocultaci√≥n de carpeta abierto");
  };

  console.log("‚úÖ openRenameModal, confirmarEliminarCarpeta y confirmarOcultarCarpeta definidas globalmente en usuario_carpetas.html");

  // Variables globales necesarias para openMoveModal
  window.ESTRUCTURAS_USUARIOS = {{ estructuras_usuarios_json|safe }};
  window.CURRENT_USER_EMAIL = {{ usuario_actual.email|tojson|safe }};
  window.CURRENT_USER_ID = {{ usuario_actual.id|tojson|safe }};
  window.USUARIOS_EMAILS = {}; // Variable vac√≠a por defecto

  // Tambi√©n mantener las variables locales para compatibilidad
  const ESTRUCTURAS_USUARIOS = window.ESTRUCTURAS_USUARIOS;
  const CURRENT_USER_EMAIL = window.CURRENT_USER_EMAIL;
  const CURRENT_USER_ID = window.CURRENT_USER_ID;
  const USUARIOS_EMAILS = window.USUARIOS_EMAILS;

  console.log("üîß Variables globales cargadas en usuario_carpetas.html:");
  console.log("  ESTRUCTURAS_USUARIOS:", window.ESTRUCTURAS_USUARIOS);
  console.log("  CURRENT_USER_EMAIL:", window.CURRENT_USER_EMAIL);
  console.log("  CURRENT_USER_ID:", window.CURRENT_USER_ID);
  console.log("  USUARIOS_EMAILS:", window.USUARIOS_EMAILS);

  // Funci√≥n simple de renderizado como fallback
  function renderizarArbolSimple(estructura, usuarioEmail) {
    console.log("üîß renderizarArbolSimple llamado con:", { estructura, usuarioEmail });

    if (!estructura || !estructura._subcarpetas) {
      return '<div class="text-center py-4 text-gray-500">No hay carpetas disponibles.</div>';
    }

    const subcarpetas = Object.keys(estructura._subcarpetas);
    if (subcarpetas.length === 0) {
      return '<div class="text-center py-4 text-gray-500">No hay carpetas disponibles.</div>';
    }

    let html = '<div class="space-y-2">';
    for (const [carpeta, data] of Object.entries(estructura._subcarpetas)) {
      // Construir el path completo
      const fullPath = `/${usuarioEmail}/${carpeta}`;
      const hasSub = data._subcarpetas && Object.keys(data._subcarpetas).length > 0;

      html += `
        <div class="border border-gray-200 rounded-lg overflow-hidden">
          <div class="flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 transition-colors duration-200">
            <div class="flex items-center space-x-3">
              <div class="w-6 h-6 bg-indigo-100 rounded flex items-center justify-center">
                <svg class="w-3 h-3 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
              </div>
              <span class="text-indigo-700 font-medium cursor-pointer hover:underline" onclick="selectDestino('${fullPath}', event)">${carpeta}</span>
            </div>
            ${hasSub ? '<span class="text-gray-400 text-xs">+</span>' : ''}
          </div>
        </div>
      `;
    }
    html += '</div>';

    console.log("‚úÖ HTML generado por renderizarArbolSimple");
    return html;
  }

  // Definir openMoveModal aqu√≠ para asegurar que est√© disponible
  window.openMoveModal = function (archivo, carpetaActual, usuarioId, event) {
    // Verificar que el evento viene de un bot√≥n de "Mover archivo"
    if (event && event.target) {
      const button = event.target.closest('button');
      if (!button || !button.textContent.includes('Mover archivo')) {
        console.log("üîß openMoveModal ignorado - no es un clic en bot√≥n de mover archivo");
        return;
      }
    }

    console.log("üîß openMoveModal EJECUT√ÅNDOSE con:", {
      archivo,
      carpetaActual,
      usuarioId,
    });

    // Verificar elementos paso a paso con logs detallados
    console.log("üîß Buscando modal moveModal...");
    const modal = document.getElementById("moveModal");
    console.log("üîß Modal encontrado:", !!modal);

    if (!modal) {
      console.error("‚ùå Modal moveModal no encontrado");
      return;
    }

    // Buscar elementos dentro del modal espec√≠ficamente
    console.log("üîß Buscando elementos dentro del modal...");

    // Intentar diferentes m√©todos de b√∫squeda
    let archivoInput = modal.querySelector("#moveArchivoNombre");
    let carpetaInput = modal.querySelector("#moveCarpetaActual");

    console.log(
      "üîß B√∫squeda con querySelector - Archivo input encontrado:",
      !!archivoInput
    );
    console.log(
      "üîß B√∫squeda con querySelector - Carpeta input encontrado:",
      !!carpetaInput
    );

    // Si no se encuentran, intentar con getElementById
    if (!archivoInput) {
      console.log("üîß Intentando con getElementById...");
      archivoInput = document.getElementById("moveArchivoNombre");
      console.log(
        "üîß getElementById - Archivo input encontrado:",
        !!archivoInput
      );
    }

    if (!carpetaInput) {
      console.log("üîß Intentando con getElementById...");
      carpetaInput = document.getElementById("moveCarpetaActual");
      console.log(
        "üîß getElementById - Carpeta input encontrado:",
        !!carpetaInput
      );
    }

    // Si a√∫n no se encuentran, buscar por nombre
    if (!archivoInput) {
      console.log("üîß Intentando buscar por nombre 'archivo_nombre'...");
      archivoInput = modal.querySelector('input[name="archivo_nombre"]');
      console.log(
        "üîß B√∫squeda por nombre - Archivo input encontrado:",
        !!archivoInput
      );
    }

    if (!carpetaInput) {
      console.log("üîß Intentando buscar por nombre 'carpeta_actual'...");
      carpetaInput = modal.querySelector('input[name="carpeta_actual"]');
      console.log(
        "üîß B√∫squeda por nombre - Carpeta input encontrado:",
        !!carpetaInput
      );
    }

    // Si a√∫n no se encuentran, buscar en todo el documento
    if (!archivoInput) {
      console.log(
        "üîß Intentando buscar en todo el documento por nombre 'archivo_nombre'..."
      );
      archivoInput = document.querySelector('input[name="archivo_nombre"]');
      console.log(
        "üîß B√∫squeda global por nombre - Archivo input encontrado:",
        !!archivoInput
      );
    }

    if (!carpetaInput) {
      console.log(
        "üîß Intentando buscar en todo el documento por nombre 'carpeta_actual'..."
      );
      carpetaInput = document.querySelector('input[name="carpeta_actual"]');
      console.log(
        "üîß B√∫squeda global por nombre - Carpeta input encontrado:",
        !!carpetaInput
      );
    }

    if (!archivoInput) {
      console.log("üîß Creando elemento moveArchivoNombre din√°micamente...");
      // Buscar el formulario dentro del modal
      const form = modal.querySelector("#moveForm");
      if (form) {
        archivoInput = document.createElement("input");
        archivoInput.type = "hidden";
        archivoInput.id = "moveArchivoNombre";
        archivoInput.name = "archivo_nombre";
        archivoInput.value = "";
        form.insertBefore(archivoInput, form.firstChild);
        console.log("üîß Elemento moveArchivoNombre creado din√°micamente");
      } else {
        console.error("‚ùå Formulario moveForm no encontrado");
        return;
      }
    }

    if (!carpetaInput) {
      console.log("üîß Creando elemento moveCarpetaActual din√°micamente...");
      // Buscar el formulario dentro del modal
      const form = modal.querySelector("#moveForm");
      if (form) {
        carpetaInput = document.createElement("input");
        carpetaInput.type = "hidden";
        carpetaInput.id = "moveCarpetaActual";
        carpetaInput.name = "carpeta_actual";
        carpetaInput.value = "";
        form.insertBefore(carpetaInput, form.firstChild);
        console.log("üîß Elemento moveCarpetaActual creado din√°micamente");
      } else {
        console.error("‚ùå Formulario moveForm no encontrado");
        return;
      }
    }

    console.log(
      "üîß Todos los elementos encontrados, estableciendo valores..."
    );
    console.log("üîß archivo:", archivo, "carpetaActual:", carpetaActual);

    // Establecer valores con verificaci√≥n adicional
    try {
      archivoInput.value = archivo;
      console.log("üîß Archivo input value establecido correctamente");
    } catch (error) {
      console.error("‚ùå Error estableciendo archivo input value:", error);
      return;
    }

    try {
      carpetaInput.value = carpetaActual;
      console.log("üîß Carpeta input value establecido correctamente");
    } catch (error) {
      console.error("‚ùå Error estableciendo carpeta input value:", error);
      return;
    }

    // Guardar el usuarioId en el modal para uso posterior
    modal.dataset.usuarioId = usuarioId;

    // Ocultar todos los men√∫s antes de mostrar el modal
    if (window.hideAllMenus) {
      window.hideAllMenus();
    }

    // Mostrar el modal despu√©s de establecer los valores
    console.log("üîß Mostrando modal...");
    modal.classList.remove("hidden");

    // Verificar que los elementos est√©n realmente en el DOM despu√©s de mostrar el modal
    setTimeout(() => {
      console.log("üîß Verificaci√≥n final despu√©s de mostrar el modal:");
      const finalArchivoInput =
        document.getElementById("moveArchivoNombre");
      const finalCarpetaInput =
        document.getElementById("moveCarpetaActual");

      console.log(
        "üîß Verificaci√≥n final - Archivo input:",
        !!finalArchivoInput
      );
      console.log(
        "üîß Verificaci√≥n final - Carpeta input:",
        !!finalCarpetaInput
      );

      if (finalArchivoInput && finalCarpetaInput) {
        console.log(
          "üîß Elementos encontrados en verificaci√≥n final, estableciendo valores..."
        );
        try {
          finalArchivoInput.value = archivo;
          finalCarpetaInput.value = carpetaActual;
          console.log("üîß Valores establecidos en verificaci√≥n final");
        } catch (error) {
          console.error("‚ùå Error en verificaci√≥n final:", error);
        }
      }
    }, 50);

    console.log("üîß Modal abierto correctamente");

    // Renderizar el √°rbol de carpetas despu√©s de abrir el modal
    console.log("üîß Iniciando renderizado del √°rbol de carpetas...");

    // Funci√≥n para renderizar el √°rbol cuando las variables est√©n disponibles
    const renderizarArbol = () => {
      // Obtener las estructuras de carpetas
      const estructurasUsuarios = window.ESTRUCTURAS_USUARIOS;

      // DETERMINAR EL USUARIO CORRECTO
      // Si estamos en /usuario/id/carpetas, usar el usuario espec√≠fico de la p√°gina
      // Si no, usar el usuario actual
      let usuarioObjetivo = window.CURRENT_USER_ID;
      let usuarioEmail = window.CURRENT_USER_EMAIL;

      // Verificar si estamos en una p√°gina de usuario espec√≠fico
      const urlPath = window.location.pathname;
      const usuarioMatch = urlPath.match(/\/usuario\/(\d+)\/carpetas/);

      if (usuarioMatch) {
        // Estamos en /usuario/id/carpetas, usar el usuario espec√≠fico
        const usuarioEspecificoId = usuarioMatch[1];
        console.log("üîß Detectado en p√°gina de usuario espec√≠fico:", {
          urlPath: urlPath,
          usuarioEspecificoId: usuarioEspecificoId,
          usuarioActual: window.CURRENT_USER_ID,
        });

        // Buscar la estructura del usuario espec√≠fico
        if (
          estructurasUsuarios &&
          estructurasUsuarios[usuarioEspecificoId]
        ) {
          usuarioObjetivo = usuarioEspecificoId;
          console.log(
            "‚úÖ Usando usuario espec√≠fico de la p√°gina:",
            usuarioObjetivo
          );
        } else if (
          estructurasUsuarios &&
          estructurasUsuarios[String(usuarioEspecificoId)]
        ) {
          usuarioObjetivo = String(usuarioEspecificoId);
          console.log(
            "‚úÖ Usando usuario espec√≠fico de la p√°gina (string):",
            usuarioObjetivo
          );
        } else {
          console.log(
            "‚ö†Ô∏è Usuario espec√≠fico no encontrado en estructuras, usando usuario actual"
          );
        }
      } else {
        console.log(
          "üîß Usando usuario actual (no en p√°gina de usuario espec√≠fico):",
          usuarioObjetivo
        );
      }

      console.log(
        "üîß DEBUG - Estructuras disponibles:",
        estructurasUsuarios
      );
      console.log("üîß DEBUG - Usuario objetivo:", usuarioObjetivo);
      console.log("üîß DEBUG - Email del usuario:", usuarioEmail);

      if (estructurasUsuarios && usuarioObjetivo) {
        // Obtener la estructura del usuario objetivo (manejar tanto string como n√∫mero)
        let estructuraUsuario = null;
        if (estructurasUsuarios[usuarioObjetivo]) {
          estructuraUsuario = estructurasUsuarios[usuarioObjetivo];
          console.log(
            "‚úÖ Estructura encontrada con clave:",
            usuarioObjetivo
          );
        } else if (estructurasUsuarios[String(usuarioObjetivo)]) {
          estructuraUsuario = estructurasUsuarios[String(usuarioObjetivo)];
          console.log(
            "‚úÖ Estructura encontrada con clave string:",
            String(usuarioObjetivo)
          );
        } else {
          console.log(
            "‚ùå No se encontr√≥ estructura para el usuario objetivo:",
            usuarioObjetivo
          );
        }

        // Renderizar el √°rbol de carpetas destino
        const destinoTree = document.getElementById("destinoTree");
        console.log("üîß Elemento destinoTree encontrado:", !!destinoTree);

        if (
          destinoTree &&
          estructuraUsuario &&
          estructuraUsuario._subcarpetas
        ) {
          console.log(
            "‚úÖ Estructura del usuario encontrada, renderizando √°rbol..."
          );

          // Limpiar el estado de carpetas expandidas
          if (window.expandedFolders) {
            window.expandedFolders.clear();
          }

          // Renderizar el √°rbol con la funci√≥n disponible
          if (typeof window.renderDestinoTreeExpandible === "function") {
            console.log("‚úÖ renderDestinoTreeExpandible est√° disponible");

            try {
              const html = window.renderDestinoTreeExpandible(estructuraUsuario, "");
              console.log("üîç HTML generado:", html);

              if (html && html.trim().length > 0) {
                destinoTree.innerHTML = html;
                console.log("‚úÖ HTML insertado en destinoTree exitosamente");
              } else {
                throw new Error("HTML vac√≠o generado");
              }
            } catch (error) {
              console.error("‚ùå Error renderizando √°rbol:", error);
              destinoTree.innerHTML = `
              <div class="text-center py-8">
                <svg class="w-16 h-16 text-red-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                </svg>
                <p class="text-red-500 text-sm font-medium">Error de renderizado</p>
                <p class="text-xs text-gray-400 mt-2">${error.message}</p>
              </div>
            `;
            }
          } else if (typeof window.renderDestinoTree === "function") {
            console.log("‚úÖ renderDestinoTree est√° disponible");

            try {
              const html = window.renderDestinoTree(
                estructuraUsuario,
                `/${usuarioEmail || "usuario"}`,
                0,
                true
              );
              console.log("üîç HTML generado:", html);

              if (html && html.trim().length > 0) {
                destinoTree.innerHTML = `
                <div class="folder-tree-container">
                  <style>
                    .folder-tree-container .tree-content { transition: all 0.3s ease-in-out; }
                    .folder-tree-container .group:hover { transform: translateX(2px); }
                    .folder-tree-container .carpeta-destino { position: relative; }
                    .folder-tree-container .carpeta-destino::before {
                      content: ''; position: absolute; left: -8px; top: 0; bottom: 0; width: 2px;
                      background: linear-gradient(to bottom, #e5e7eb 0%, transparent 100%); opacity: 0.5;
                    }
                  </style>
                  ${html}
                </div>
              `;
                console.log(
                  "‚úÖ HTML insertado en destinoTree con estilos mejorados"
                );
              } else {
                throw new Error("HTML vac√≠o generado");
              }
            } catch (error) {
              console.error("‚ùå Error renderizando √°rbol:", error);
              destinoTree.innerHTML = `
              <div class="text-center py-8">
                <svg class="w-16 h-16 text-red-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                </svg>
                <p class="text-red-500 text-sm font-medium">Error de renderizado</p>
                <p class="text-xs text-gray-400 mt-2">${error.message}</p>
              </div>
            `;
            }
          } else {
            console.error("‚ùå Ninguna funci√≥n de renderizado est√° disponible");
            // Crear una funci√≥n simple de renderizado como fallback
            try {
              const html = renderizarArbolSimple(estructuraUsuario, usuarioEmail);
              destinoTree.innerHTML = html;
              console.log("‚úÖ √Årbol renderizado con funci√≥n simple");
            } catch (error) {
              console.error("‚ùå Error con funci√≥n simple:", error);
              destinoTree.innerHTML = `
              <div class="text-center py-8">
                <svg class="w-16 h-16 text-red-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                </svg>
                <p class="text-red-500 text-sm font-medium">Funci√≥n no disponible</p>
                <p class="text-xs text-gray-400 mt-2">Ninguna funci√≥n de renderizado est√° definida</p>
              </div>
            `;
            }
          }
        } else {
          console.log("‚ùå No se encontr√≥ estructura para el usuario actual");
          destinoTree.innerHTML = `
          <div class="text-center py-8">
            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2h-6l-2-2H5a2 2 0 00-2 2z"/>
            </svg>
            <p class="text-gray-500 text-sm font-medium">No se encontraron carpetas</p>
            <p class="text-xs text-gray-400 mt-2">Usuario ID: ${usuarioObjetivo}</p>
            <p class="text-xs text-gray-400">Email: ${usuarioEmail}</p>
          </div>
        `;
        }
      } else {
        console.log("‚ùå Variables no disponibles");
        destinoTree.innerHTML = `
        <div class="text-center py-8">
          <svg class="w-16 h-16 text-red-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"/>
          </svg>
          <p class="text-red-500 text-sm font-medium">Variables no disponibles</p>
          <p class="text-xs text-gray-400 mt-2">estructurasUsuarios: ${!!estructurasUsuarios}</p>
          <p class="text-xs text-gray-400">usuarioObjetivo: ${!!usuarioObjetivo}</p>
        </div>
      `;
      }
    };

    // Attempt to render immediately
    renderizarArbol();

    // If variables are not available, wait and retry
    if (!window.ESTRUCTURAS_USUARIOS || !window.CURRENT_USER_ID) {
      console.log("üîß Variables no disponibles, esperando...");
      setTimeout(() => renderizarArbol(), 100);
      setTimeout(() => renderizarArbol(), 500);
      setTimeout(() => renderizarArbol(), 1000);
    }

    document.querySelector('#moveForm button[type="submit"]').disabled = true;
  };

  console.log("‚úÖ openMoveModal definida en usuario_carpetas.html");

  // Estado de archivo
  window.openStatusModal = function(filename, parentPath, usuarioId) {
    const modal = document.getElementById('statusModal');
    const fullPath = `/${"{{ usuario.email }}"}/${parentPath ? parentPath + '/' : ''}${filename}`.replace(/\/+/g, '/');
    document.getElementById('statusFileName').textContent = filename;
    document.getElementById('statusFilePath').value = fullPath;
    const badgeId = `status-badge-${(parentPath || '').replaceAll('/', '-').replaceAll('\\\\', '-')}-${filename.replaceAll('/', '-').replaceAll('\\\\', '-')}`;
    document.getElementById('statusFileIdForBadge').value = badgeId;
    // Cargar estado actual
    fetch(`/api/archivo/estado?path=${encodeURIComponent(fullPath)}`)
      .then(r => r.json())
      .then(d => {
        const estado = d && d.estado ? d.estado : 'en_revision';
        document.querySelectorAll('input[name="estadoArchivo"]').forEach(r => r.checked = (r.value === estado));
      }).catch(() => {});
    modal.classList.remove('hidden');
  };

  window.closeStatusModal = function() {
    document.getElementById('statusModal').classList.add('hidden');
  };

  window.saveStatus = function() {
    const path = document.getElementById('statusFilePath').value;
    const estado = document.querySelector('input[name="estadoArchivo"]:checked').value;
    fetch('/api/archivo/estado', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path, estado })
    }).then(r => r.json()).then(d => {
      if (d && d.success) {
        const badgeId = document.getElementById('statusFileIdForBadge').value;
        const badge = document.getElementById(badgeId);
        if (badge) {
          badge.dataset.filePath = path;
          if (estado === 'validado' || estado === 'rechazado' || estado === 'en_revision') {
            badge.classList.remove('hidden');
            // Primero ajustar color/etiqueta por estado
            badge.className = `ml-2 text-xs font-medium px-2 py-0.5 rounded-full ${estado === 'validado' ? 'bg-green-100 text-green-700' : estado === 'rechazado' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}`;
            // Consultar visibilidad para agregar indicador "Privada" si aplica
            fetch(`/api/archivo/estado?path=${encodeURIComponent(path)}`)
              .then(rr => rr.json())
              .then(dd => {
                const esPublica = !(dd && dd.hasOwnProperty('es_publica')) ? true : !!dd.es_publica;
                const estadoTexto = estado === 'validado' ? 'Validado' : (estado === 'rechazado' ? 'Rechazado' : 'Pendiente para revisi√≥n');
                if (!esPublica) {
                  // Fuerza color rojo si es privada
                  badge.className = 'ml-2 text-xs font-medium px-2 py-0.5 rounded-full bg-red-100 text-red-700';
                  badge.textContent = `${estadoTexto} ¬∑ Privada`;
                } else {
                  badge.textContent = estadoTexto;
                }
              }).catch(() => {
                const estadoTexto = estado === 'validado' ? 'Validado' : (estado === 'rechazado' ? 'Rechazado' : 'Pendiente para revisi√≥n');
                badge.textContent = estadoTexto;
              });
          } else {
            // Sin estado; mostrar s√≥lo privacidad si es privada
            fetch(`/api/archivo/estado?path=${encodeURIComponent(path)}`)
              .then(rr => rr.json())
              .then(dd => {
                const esPublica = !(dd && dd.hasOwnProperty('es_publica')) ? true : !!dd.es_publica;
                if (esPublica === false) {
                  badge.classList.remove('hidden');
                  badge.className = 'ml-2 text-xs font-medium px-2 py-0.5 rounded-full bg-red-100 text-red-700';
                  badge.textContent = 'Privada';
                } else {
                  badge.classList.add('hidden');
                }
              }).catch(() => {
                badge.classList.add('hidden');
              });
          }
        }
        closeStatusModal();
      }
    }).catch(() => {
      closeStatusModal();
    });
  };

  // Inicializar badges de estado al cargar/recargar la p√°gina
  function initStatusBadges() {
    const badges = Array.from(document.querySelectorAll('span[id^="status-badge-"][data-file-path]'));
    if (!badges.length) return;
    badges.forEach(badge => {
      const filePath = badge.dataset.filePath;
      if (!filePath) return;
      fetch(`/api/archivo/estado?path=${encodeURIComponent(filePath)}`)
        .then(r => r.json())
        .then(d => {
          const estado = (d && d.estado) ? d.estado : null;
          const esPublica = !(d && d.hasOwnProperty('es_publica')) ? true : !!d.es_publica;
          // Si el usuario actual es cliente y el archivo es privado, ocultar el item del √°rbol
          if (window.CURRENT_USER_ROLE === 'cliente' && esPublica === false) {
            const item = badge.closest('div.flex.items-center.justify-between');
            if (item && item.parentElement) {
              // El wrapper del archivo es el contenedor con padding (p-3)
              const wrapper = item.parentElement;
              if (wrapper && wrapper.classList && wrapper.classList.contains('p-3')) {
                wrapper.style.display = 'none';
                return; // No continuar pintando badge para elementos ocultos
              }
              // Fallback: ocultar el contenedor encontrado
              item.style.display = 'none';
              return;
            }
          }
          if (estado === 'validado' || estado === 'rechazado' || estado === 'en_revision') {
            badge.classList.remove('hidden');
            const estadoTexto = estado === 'validado' ? 'Validado' : (estado === 'rechazado' ? 'Rechazado' : 'Pendiente para revisi√≥n');
            badge.textContent = esPublica ? estadoTexto : `${estadoTexto} ¬∑ Privada`;
            badge.className = `ml-2 text-xs font-medium px-2 py-0.5 rounded-full ${estado === 'validado' ? 'bg-green-100 text-green-700' : estado === 'rechazado' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}`;
          } else {
            // Sin estado; si es privada, mostrarlo
            if (esPublica === false) {
              badge.classList.remove('hidden');
              badge.textContent = 'Privada';
              badge.className = 'ml-2 text-xs font-medium px-2 py-0.5 rounded-full bg-red-100 text-red-700';
            } else {
              badge.classList.add('hidden');
            }
          }
        })
        .catch(() => {
          // Si falla, mantener oculto
        });
    });
  }

  document.addEventListener('DOMContentLoaded', initStatusBadges);

  // Definir renderDestinoTreeExpandible primero
  window.renderDestinoTreeExpandible = function (tree, path) {
    console.log("=== renderDestinoTreeExpandible ===");
    console.log("Par√°metros:", { tree, path });
    console.log("¬øtree existe?:", !!tree);
    console.log("¬øtree._subcarpetas existe?:", !!(tree && tree._subcarpetas));

    if (!tree || !tree._subcarpetas) {
      console.log("‚ùå No hay subcarpetas en el √°rbol");
      return '<div class="text-center py-4 text-gray-500">No hay carpetas disponibles.</div>';
    }

    const subcarpetas = Object.keys(tree._subcarpetas);
    console.log("‚úÖ Subcarpetas encontradas:", subcarpetas);
    console.log("N√∫mero de subcarpetas:", subcarpetas.length);

    if (subcarpetas.length === 0) {
      console.log("‚ùå No hay subcarpetas para renderizar");
      return '<div class="text-center py-4 text-gray-500">No hay carpetas disponibles.</div>';
    }

    let html = '<div class="space-y-2">';
    console.log("Iniciando bucle de renderizado...");
    for (const [carpeta, data] of Object.entries(tree._subcarpetas)) {
      console.log("üîÑ Renderizando carpeta:", carpeta);
      console.log("   Datos de la carpeta:", data);

      // Construir el path completo para el usuario espec√≠fico
      let fullPath;
      if (path === "") {
        // Si estamos en la ra√≠z, solo agregar el email del usuario y la carpeta
        fullPath = "/{{ usuario.email }}/" + carpeta;
      } else {
        // Si ya tenemos un path, agregar la carpeta al final
        fullPath = path + "/" + carpeta;
      }

      const hasSub =
        data._subcarpetas && Object.keys(data._subcarpetas).length > 0;
      const nodeId = "node-" + btoa(fullPath).replace(/=/g, "");

      html += `
        <div class="border border-gray-200 rounded-lg overflow-hidden">
          <div class="flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 transition-colors duration-200">
            <div class="flex items-center space-x-3">
              <div class="w-6 h-6 bg-indigo-100 rounded flex items-center justify-center">
                <svg class="w-3 h-3 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
              </div>
              <span class="text-indigo-700 font-medium cursor-pointer hover:underline" onclick="selectDestino('${fullPath}', event)">${carpeta}</span>
            </div>
            ${
              hasSub
                ? `<button class="text-gray-400 hover:text-gray-600 transition-colors duration-200" onclick="toggleDestinoSubcarpetas('${nodeId}', this)">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </button>`
                : ""
            }
          </div>
          ${
            hasSub
              ? `<div id="${nodeId}" class="subcarpetas hidden p-2 bg-white border-t border-gray-200">
            ${window.renderDestinoTreeExpandible(data, fullPath)}
          </div>`
              : ""
          }
        </div>
      `;
    }
    html += "</div>";
    console.log("‚úÖ HTML generado exitosamente");
    console.log("Longitud del HTML:", html.length);
    return html;
  };

  // Definir toggleDestinoSubcarpetas
  window.toggleDestinoSubcarpetas = function (nodeId, el) {
    const sub = document.getElementById(nodeId);
    const svg = el.querySelector("svg");
    if (sub.classList.contains("hidden")) {
      sub.classList.remove("hidden");
      svg.style.transform = "rotate(180deg)";
    } else {
      sub.classList.add("hidden");
      svg.style.transform = "rotate(0deg)";
    }
  };

  console.log(
    "Funciones renderDestinoTreeExpandible y toggleDestinoSubcarpetas definidas"
  );

    // Event listener para preservar la extensi√≥n al renombrar archivos
  document.addEventListener('DOMContentLoaded', function() {
    const renameForm = document.getElementById('renameForm');
    if (renameForm) {
      renameForm.addEventListener('submit', function(e) {
        const newNameInput = document.getElementById('newName');
        const extensionInput = document.getElementById('archivoExtension');

        if (newNameInput && extensionInput && extensionInput.value) {
          // Combinar el nuevo nombre con la extensi√≥n original
          const nuevoNombreCompleto = newNameInput.value + extensionInput.value;

          // Actualizar el campo que se env√≠a al servidor (el campo visible con name="nuevo_nombre")
          newNameInput.value = nuevoNombreCompleto;

          console.log('‚úÖ Nombre combinado:', nuevoNombreCompleto);
        }
      });
    }
  });
</script>

<!-- Script para comentar que usamos la funci√≥n de base.html -->
<script>
  // NOTA: Usamos la funci√≥n openMoveModal de base.html que ya tiene
  // la l√≥gica correcta para detectar el usuario espec√≠fico de la p√°gina
  console.log("usuario_carpetas.html: Usando openMoveModal de base.html");
</script>

<script>
  function handleFolderClick(folderId, event) {
    // Detener la propagaci√≥n del evento para evitar conflictos
    if (event) {
      event.stopPropagation();
      event.preventDefault();
    }

    // Solo ejecutar toggleFolder, no otras funciones
    toggleFolder(folderId);
  }

  function toggleFolder(folderId) {
    const div = document.getElementById("folder-" + folderId);
    const icon = document.getElementById("icon-" + folderId);
    if (!div) return;

    if (div.classList.contains("hidden")) {
      div.classList.remove("hidden");
      if (icon) {
        icon.style.transform = "rotate(90deg)";
      }
    } else {
      div.classList.add("hidden");
      if (icon) {
        icon.style.transform = "rotate(0deg)";
      }
    }
  }

  // Funciones para manejar modales
  function openModal(modalId) {
    document.getElementById(modalId).classList.remove("hidden");
  }

  function closeModal(modalId) {
    document.getElementById(modalId).classList.add("hidden");
  }

  function closeMoveModal() {
    document.getElementById("moveModal").classList.add("hidden");
  }

  function selectDestino(path, event) {
    // Detener la propagaci√≥n del evento para evitar acciones no deseadas
    if (event) {
      event.stopPropagation();
      event.preventDefault();
    }

    console.log("selectDestino llamado con path:", path);

    // Construir la ruta completa con el email del usuario espec√≠fico
    let rutaCompleta = path;

    // Si el path no empieza con /, agregarlo
    if (!rutaCompleta.startsWith("/")) {
      rutaCompleta = "/" + rutaCompleta;
    }

    // Agregar el email del usuario espec√≠fico si no est√° ya incluido
    let usuarioEmail = "{{ usuario.email }}";
    if (usuarioEmail && !rutaCompleta.startsWith("/" + usuarioEmail)) {
      rutaCompleta = "/" + usuarioEmail + rutaCompleta;
    }

    console.log("Ruta final seleccionada:", {
      pathOriginal: path,
      usuarioEmail: usuarioEmail,
      rutaCompleta: rutaCompleta,
    });

        // Guardar el path seleccionado y habilitar el bot√≥n
    document.getElementById("nuevaCarpetaSeleccionada").value = rutaCompleta;
    const selectedDiv = document.getElementById("selectedFolder");
    selectedDiv.classList.remove("hidden");
    selectedDiv.querySelector(
      "span"
    ).innerText = `Destino seleccionado: ${rutaCompleta}`;

    // Habilitar el bot√≥n cuando se selecciona una carpeta v√°lida
    console.log("üîß Buscando bot√≥n de submit...");
    const submitButton = document.getElementById('moveSubmitButton');
    console.log("üîß Bot√≥n encontrado:", !!submitButton);

    if (submitButton) {
      console.log("üîß Estado actual del bot√≥n:", submitButton.disabled);
      submitButton.disabled = false;
      console.log("üîß Nuevo estado del bot√≥n:", submitButton.disabled);
      console.log("‚úÖ Bot√≥n de mover archivo habilitado al seleccionar carpeta");
    } else {
      console.error("‚ùå No se encontr√≥ el bot√≥n de submit con ID");
      // Intentar con selector alternativo
      const altButton = document.querySelector('button[form="moveForm"]');
      console.log("üîß Bot√≥n alternativo encontrado:", !!altButton);
      if (altButton) {
        altButton.disabled = false;
        console.log("‚úÖ Bot√≥n alternativo habilitado");
      }
    }
  }



  // Validaci√≥n del formulario de mover archivo
  document.getElementById("moveForm").onsubmit = function (e) {
    // Permitir env√≠o tambi√©n v√≠a Enter o program√°tico (sin e.submitter)
    if (e.submitter && !e.submitter.textContent.includes('Mover archivo')) {
      console.log("‚ùå Formulario bloqueado - submitter no es bot√≥n de mover archivo");
      e.preventDefault();
      return false;
    }

    const dest = document.getElementById("nuevaCarpetaSeleccionada").value;
    const archivo = document.getElementById("moveArchivoNombre").value;
    const carpetaActual = document.getElementById("moveCarpetaActual").value;
    const usuarioId = document.querySelector('input[name="usuario_id"]').value;

    console.log("Enviando formulario de mover archivo:", {
      archivo: archivo,
      carpetaActual: carpetaActual,
      nuevaCarpeta: dest,
      usuarioId: usuarioId,
    });

    if (!dest || dest.trim() === "") {
      document.getElementById("selectedFolder").classList.remove("hidden");
      document
        .getElementById("selectedFolder")
        .querySelector("span").innerText =
        "‚ö†Ô∏è Selecciona una carpeta de destino.";
      e.preventDefault();
      return false;
    }
    return true;
  };

  // Cerrar modales al hacer clic fuera de ellos
  window.onclick = function (event) {
    const modals = [
      "createFolderModal",
      "uploadFileModal",
      "renameModal",
      "moveModal",
    ];
    modals.forEach((modalId) => {
      const modal = document.getElementById(modalId);
      if (event.target === modal) {
        closeModal(modalId);
      }
    });
  };

  // Funciones para manejar los men√∫s desplegables
  function toggleFileMenu(menuId, event) {
    const menu = document.getElementById(menuId);
    if (menu) {
      if (menu.classList.contains("hidden")) {
        // Posicionar el men√∫ cerca del bot√≥n
        const button = event.currentTarget;
        const rect = button.getBoundingClientRect();
        menu.style.top = rect.bottom + 5 + "px";
        menu.style.left = rect.right - menu.offsetWidth + "px";
        menu.classList.remove("hidden");
      } else {
        menu.classList.add("hidden");
      }
    }
  }


  // Funci√≥n para cerrar todos los men√∫s
  window.hideAllMenus = function() {
    const menus = document.querySelectorAll(
      '[id^="file-menu-"], [id^="folder-menu-"]'
    );
    menus.forEach((menu) => {
      menu.classList.add("hidden");
    });
  };

  // Cerrar todos los men√∫s al hacer clic fuera de ellos
  document.addEventListener("click", function (event) {
    const menus = document.querySelectorAll(
      '[id^="file-menu-"], [id^="folder-menu-"]'
    );
    menus.forEach((menu) => {
      if (!menu.contains(event.target) && !event.target.closest("button")) {
        menu.classList.add("hidden");
      }
    });
  });

  // Cerrar men√∫s cuando se hace clic en cualquier opci√≥n del men√∫
  document.addEventListener("click", function (event) {
    const target = event.target;
    // Si se hace clic en un bot√≥n dentro de un men√∫ de archivo o carpeta
    if (target.tagName === 'BUTTON' && target.closest('[id^="file-menu-"], [id^="folder-menu-"]')) {
      // Esperar un poco para que la acci√≥n se ejecute antes de cerrar
      setTimeout(() => {
        window.hideAllMenus();
      }, 100);
    }
  });

  // Asegurar que los clics en carpetas no interfieran con otras funcionalidades
  document.addEventListener("click", function (event) {
    // Si el clic es en un elemento que tiene onclick con toggleFolder, no hacer nada m√°s
    const target = event.target.closest('[onclick*="toggleFolder"]');
    if (target) {
      // El evento ya est√° manejado por toggleFolder, no hacer nada adicional
      return;
    }
  });

  // Cerrar men√∫s al hacer scroll
  window.addEventListener("scroll", function () {
    const menus = document.querySelectorAll(
      '[id^="file-menu-"], [id^="folder-menu-"]'
    );
    menus.forEach((menu) => {
      if (!menu.classList.contains("hidden")) {
        menu.classList.add("hidden");
      }
    });
  });

  // Script para modificar los botones del macro despu√©s de que se cargue la p√°gina
  document.addEventListener("DOMContentLoaded", function () {
    console.log("DOM cargado, modificando botones de mover archivo...");

    // Buscar espec√≠ficamente los botones de "Mover archivo" dentro de los men√∫s de archivos
    const moveButtons = document.querySelectorAll(
      '[id^="file-menu-"] button[onclick*="openMoveModal"]'
    );
    console.log("Botones de mover archivo encontrados:", moveButtons.length);

    moveButtons.forEach((button) => {
      const onclick = button.getAttribute("onclick");
      console.log("onclick original:", onclick);

      // Extraer los par√°metros del onclick original
      const match = onclick.match(
        /openMoveModal\('([^']+)',\s*'([^']+)',\s*'([^']+)'\)/
      );
      if (match) {
        const fileName = match[1];
        const currentPath = match[2];
        const usuarioId = match[3];

        console.log("Par√°metros extra√≠dos:", {
          fileName,
          currentPath,
          usuarioId,
        });

        // Crear nuevo onclick que use nuestra funci√≥n
        const newOnclick = `openMoveModal('${fileName}', '${currentPath}', '{{ usuario.id }}', event)`;
        button.setAttribute("onclick", newOnclick);

        console.log("Nuevo onclick:", newOnclick);
      }
    });
  });

    // Funci√≥n de prueba para debug
  function testEstructura() {
    console.log("=== TEST ESTRUCTURA ===");
    console.log("Usuario ID:", "{{ usuario.id }}");
    console.log("Usuario Email:", "{{ usuario.email }}");

    const estructurasUsuarios = {{ estructuras_usuarios_json|safe }};
    const estructura = estructurasUsuarios["{{ usuario.id }}"];

    console.log("Estructuras usuarios:", estructurasUsuarios);
    console.log("Estructura del usuario:", estructura);
    console.log("¬øEstructura es null/undefined?:", estructura == null);
    console.log("¬øTiene _subcarpetas?:", estructura && estructura._subcarpetas);
    console.log("¬øCu√°ntas subcarpetas?:", estructura && estructura._subcarpetas ? Object.keys(estructura._subcarpetas).length : 0);
    console.log("Carpetas encontradas:", estructura && estructura._subcarpetas ? Object.keys(estructura._subcarpetas) : []);

    // Probar renderDestinoTreeExpandible
    if (typeof window.renderDestinoTreeExpandible === 'function') {
      console.log("‚úÖ renderDestinoTreeExpandible est√° disponible");
      const resultado = window.renderDestinoTreeExpandible(estructura, "");
      console.log("Resultado de renderDestinoTreeExpandible:", resultado);
    } else {
      console.log("‚ùå renderDestinoTreeExpandible NO est√° disponible");
    }

    alert(`Estructura de debug:\nUsuario: {{ usuario.email }}\nCarpetas: ${estructura && estructura._subcarpetas ? Object.keys(estructura._subcarpetas).length : 0}\nCarpetas: ${estructura && estructura._subcarpetas ? Object.keys(estructura._subcarpetas).join(', ') : 'Ninguna'}`);
  }

  // Funci√≥n para confirmar eliminaci√≥n de archivo
  function confirmarEliminarArchivo(archivo, carpeta, usuarioId) {
    console.log("üîß confirmarEliminarArchivo llamado con:", { archivo, carpeta, usuarioId });

    // Configurar el modal de confirmaci√≥n
    const modal = document.getElementById('deleteConfirmModal');
    const itemName = document.getElementById('deleteItemName');
    const itemDescription = document.getElementById('deleteItemDescription');
    const form = document.getElementById('deleteConfirmForm');
    const usuarioIdInput = document.getElementById('deleteUsuarioId');
    const carpetaActualInput = document.getElementById('deleteCarpetaActual');
    const itemNombreInput = document.getElementById('deleteItemNombre');
    const itemTipoInput = document.getElementById('deleteItemTipo');

    if (!modal || !itemName || !itemDescription || !form) {
      console.error("‚ùå Elementos del modal de eliminaci√≥n no encontrados");
      alert("Error: No se pudo abrir el modal de confirmaci√≥n. Recarga la p√°gina e intenta de nuevo.");
      return;
    }

                // Configurar el contenido del modal
            itemName.textContent = `"${archivo}"`;
            itemDescription.textContent = "Este archivo ser√° eliminado permanentemente de Dropbox y no se podr√° recuperar.";

    // Configurar el formulario
    usuarioIdInput.value = usuarioId;
    carpetaActualInput.value = carpeta;
    itemNombreInput.value = archivo;
    itemTipoInput.value = 'archivo';

    // Configurar la acci√≥n del formulario
    form.action = '{{ url_for("listar_dropbox.eliminar_archivo") }}';

    // Ocultar todos los men√∫s antes de mostrar el modal
    window.hideAllMenus();

    // Mostrar el modal
    modal.classList.remove('hidden');
    console.log("üîß Modal de eliminaci√≥n de archivo abierto");
  }

  // Funciones para el modal de beneficiario
  function abrirModalBeneficiario(usuarioId, nombreUsuario) {
    console.log('Abriendo modal para usuario:', usuarioId, nombreUsuario);

    const titularIdInput = document.getElementById('titularId');
    const nombreTitularSpan = document.getElementById('nombreTitular');
    const modal = document.getElementById('modalBeneficiario');
    const form = document.getElementById('formBeneficiario');
    const mensajeDiv = document.getElementById('mensajeBeneficiario');

    if (!titularIdInput || !nombreTitularSpan || !modal || !form || !mensajeDiv) {
      console.error('Elementos del modal no encontrados');
      alert('Error: No se pudo abrir el modal. Recarga la p√°gina e intenta de nuevo.');
      return;
    }

    // Configurar datos del modal
    titularIdInput.value = usuarioId;
    nombreTitularSpan.textContent = nombreUsuario;

    // Limpiar formulario y mensajes
    form.reset();
    mensajeDiv.classList.add('hidden');
    mensajeDiv.innerHTML = '';

    // Mostrar modal
    modal.classList.remove('hidden');

    console.log('Modal abierto correctamente');
  }

  function cerrarModalBeneficiario() {
    const modal = document.getElementById('modalBeneficiario');
    if (modal) {
      modal.classList.add('hidden');
      console.log('Modal cerrado');
    }
  }

  // Manejar env√≠o del formulario de beneficiario
  document.addEventListener('DOMContentLoaded', function() {
    const formBeneficiario = document.getElementById('formBeneficiario');
    if (formBeneficiario) {
      formBeneficiario.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const mensajeDiv = document.getElementById('mensajeBeneficiario');

        // Mostrar estado de carga
        mensajeDiv.className = 'mt-4 p-3 rounded-lg bg-blue-100 text-blue-700';
        mensajeDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creando beneficiario...';
        mensajeDiv.classList.remove('hidden');

        // Enviar datos al servidor
        fetch('/users/crear_beneficiario', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        })
        .then(response => {
          console.log('Response status:', response.status);
          console.log('Response headers:', response.headers);

          if (!response.ok) {
            // Manejar errores espec√≠ficos
            if (response.status === 401) {
              throw new Error('No autenticado');
            } else if (response.status === 403) {
              throw new Error('Sin permisos');
            } else if (response.status === 500) {
              throw new Error('Error del servidor');
            } else {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
          }

          // Verificar el tipo de contenido
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Respuesta no es JSON v√°lido');
          }

          return response.json();
        })
        .then(data => {
          console.log('Response data:', data);

          if (data.success) {
            // Si el beneficiario se cre√≥ exitosamente, cerrar modal inmediatamente y recargar
            console.log('‚úÖ Beneficiario creado exitosamente, cerrando modal...');
            cerrarModalBeneficiario();
            // Recargar la p√°gina para mostrar el nuevo beneficiario
            window.location.reload();
          } else {
            mensajeDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700';
            mensajeDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${data.error || 'Error desconocido'}`;

            // Si hay redirecci√≥n sugerida, mostrarla
            if (data.redirect) {
              setTimeout(() => {
                window.location.href = data.redirect;
              }, 2000);
            }
          }
        })
        .catch(error => {
          console.error('Error completo:', error);
          mensajeDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700';

          if (error.message === 'No autenticado') {
            mensajeDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Debes iniciar sesi√≥n para crear beneficiarios. Redirigiendo...';
            setTimeout(() => {
              window.location.href = '/auth/login';
            }, 2000);
          } else if (error.message === 'Sin permisos') {
            mensajeDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>No tienes permisos para crear beneficiarios.';
          } else if (error.message === 'Respuesta no es JSON v√°lido') {
            mensajeDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Error de comunicaci√≥n con el servidor. Verifica tu sesi√≥n.';
          } else {
            mensajeDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Error al crear beneficiario. Intenta de nuevo.';
          }
          console.error('Error:', error);
        });
      });
    }

    // Cerrar modal al hacer clic fuera de √©l
    const modalBeneficiario = document.getElementById('modalBeneficiario');
    if (modalBeneficiario) {
      modalBeneficiario.addEventListener('click', function(e) {
        if (e.target === this) {
          cerrarModalBeneficiario();
        }
      });
    }

    // Configurar el formulario de eliminaci√≥n para agregar redirect_url
    const deleteForm = document.getElementById('deleteConfirmForm');
    if (deleteForm) {
      deleteForm.addEventListener('submit', function(e) {
        // Agregar redirect_url al formulario antes de enviarlo
        const redirectInput = document.createElement('input');
        redirectInput.type = 'hidden';
        redirectInput.name = 'redirect_url';
        redirectInput.value = window.location.href;
        this.appendChild(redirectInput);

        console.log("üîß Formulario de eliminaci√≥n enviado");
      });
    }
  });

  // Funci√≥n para confirmar eliminaci√≥n de carpeta
  function confirmarEliminarCarpeta(carpeta, carpetaPadre, usuarioId) {
    console.log("üîß confirmarEliminarCarpeta llamado con:", { carpeta, carpetaPadre, usuarioId });

    // Configurar el modal de confirmaci√≥n
    const modal = document.getElementById('deleteConfirmModal');
    const itemName = document.getElementById('deleteItemName');
    const itemDescription = document.getElementById('deleteItemDescription');
    const form = document.getElementById('deleteConfirmForm');
    const usuarioIdInput = document.getElementById('deleteUsuarioId');
    const carpetaActualInput = document.getElementById('deleteCarpetaActual');
    const itemNombreInput = document.getElementById('deleteItemNombre');
    const itemTipoInput = document.getElementById('deleteItemTipo');

    if (!modal || !itemName || !itemDescription || !form) {
      console.error("‚ùå Elementos del modal de eliminaci√≥n no encontrados");
      alert("Error: No se pudo abrir el modal de confirmaci√≥n. Recarga la p√°gina e intenta de nuevo.");
      return;
    }

    // Configurar el contenido del modal
    itemName.textContent = `"${carpeta}"`;
    itemDescription.textContent = "Esta carpeta y todo su contenido ser√°n eliminados permanentemente de Dropbox y no se podr√°n recuperar.";

    // Configurar el formulario
    usuarioIdInput.value = usuarioId;
    carpetaActualInput.value = carpetaPadre;
    itemNombreInput.value = carpeta;
    itemTipoInput.value = 'carpeta';

    // Configurar la acci√≥n del formulario
    form.action = '{{ url_for("listar_dropbox.eliminar_carpeta") }}';

    // Ocultar todos los men√∫s antes de mostrar el modal
    window.hideAllMenus();

    // Mostrar el modal
    modal.classList.remove('hidden');
    console.log("üîß Modal de eliminaci√≥n de carpeta abierto");
  }

  // Funci√≥n para cerrar el modal de eliminaci√≥n
  function cerrarModalEliminacion() {
    const modal = document.getElementById('deleteConfirmModal');
    if (modal) {
      modal.classList.add('hidden');
      console.log("üîß Modal de eliminaci√≥n cerrado");
    }
  }

  // ========================
  // FUNCIONES DE VISUALIZACI√ìN DE ARCHIVOS
  // ========================

  function openPreviewModal(fileId, extension, filename = "") {
    const modal = document.getElementById("viewerModal");
    const content = document.getElementById("viewerContent");
    const fileNameSpan = document.getElementById("viewerFileName");

    // Mostrar nombre del archivo
    if (fileNameSpan) {
      fileNameSpan.textContent = filename || `Archivo ${fileId}`;
    }

    content.innerHTML = `
      <div class="text-center p-6">
        <div class="inline-block w-8 h-8 border-4 border-primary/20 border-t-primary rounded-full animate-spin mb-2"></div>
        <p class="text-gray-500">Cargando vista previa...</p>
      </div>
    `;

    modal.classList.remove("hidden");

    // Verificar si es un ID num√©rico (archivo local) o una ruta (archivo Dropbox)
    const isLocalFile = !isNaN(fileId);
    const ext = extension.toLowerCase();
    console.log("Mostrando modal de vista previa para:", fileId, "Tipo:", ext);

    if (isLocalFile) {
      // Para archivos locales, usar la ruta /admin/preview_file/{id}
      fetch(`/admin/preview_file/${fileId}`)
        .then((response) => {
          if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
          }

          // Verificar el tipo de contenido
          const contentType = response.headers.get('content-type');

          if (contentType && contentType.includes('application/pdf')) {
            // Para PDF, crear blob y mostrar en iframe
            return response.blob().then((blob) => {
              const url = URL.createObjectURL(blob);
              content.innerHTML = `
                <iframe src="${url}" frameborder="0" class="w-full h-[80vh]"></iframe>
              `;
            });
          } else if (contentType && contentType.includes('image/')) {
            // Para im√°genes, crear blob y mostrar
            return response.blob().then((blob) => {
              const url = URL.createObjectURL(blob);
              content.innerHTML = `
                <img src="${url}" class="max-w-full max-h-[80vh] mx-auto" />
              `;
            });
          } else {
            // Para HTML (documentos Word), mostrar directamente
            return response.text().then((html) => {
              content.innerHTML = html;
            });
          }
        })
        .catch((error) => {
          console.error("Error al cargar la vista previa:", error);
          content.innerHTML = `
            <div class="text-center p-6">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 text-red-500 mb-4">
                <i class="fas fa-exclamation-triangle text-2xl"></i>
              </div>
              <h3 class="text-lg font-medium text-gray-900 mb-2">Error al cargar la vista previa</h3>
              <p class="text-gray-600">${error.message}</p>
            </div>
          `;
        });
    } else {
      // Para archivos de Dropbox, usar el endpoint POST
      fetch("/admin/preview_file", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ path: fileId, extension: ext }),
      })
        .then((response) => {
          if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);

          // Verificar el tipo de contenido
          const contentType = response.headers.get('content-type');

          if (contentType && contentType.includes('application/pdf')) {
            // Para PDF, crear blob y mostrar en iframe
            return response.blob().then((blob) => {
              const url = URL.createObjectURL(blob);
              content.innerHTML = `
                <iframe src="${url}" frameborder="0" class="w-full h-[80vh]"></iframe>
              `;
            });
          } else if (contentType && contentType.includes('image/')) {
            // Para im√°genes, crear blob y mostrar
            return response.blob().then((blob) => {
              const url = URL.createObjectURL(blob);
              content.innerHTML = `
                <img src="${url}" class="max-w-full max-h-[80vh] mx-auto" />
              `;
            });
          } else {
            // Para HTML (documentos Word), mostrar directamente
            return response.text().then((html) => {
              content.innerHTML = html;
            });
          }
        })
        .catch((err) => {
          console.error("Vista previa fall√≥:", err);
          content.innerHTML = `
            <div class="text-center p-6">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 text-red-500 mb-4">
                <i class="fas fa-exclamation-triangle text-2xl"></i>
              </div>
              <h3 class="text-lg font-medium text-gray-900 mb-2">Error al cargar la vista previa</h3>
              <p class="text-gray-600">${err.message}</p>
            </div>
          `;
        });
    }
  }

  function closePreviewModal() {
    const modal = document.getElementById("viewerModal");
    modal.classList.add("hidden");
  }
</script>
<script>
  function descargarArchivo(
    archivoId = "",
    path = "",
    nombre = "documento.pdf"
  ) {
    let url = "/admin/descargar_archivo?";
    if (archivoId) {
      url += `archivo_id=${archivoId}`;
    } else if (path) {
      const rutaLimpia = path.replace(/\/+/g, "/");
      url += `path=${encodeURIComponent(
        rutaLimpia
      )}&nombre=${encodeURIComponent(nombre)}`;
    } else {
      alert("No se puede descargar: faltan datos.");
      return;
    }

    console.log("Iniciando descarga:", url);
    const a = document.createElement("a");
    a.href = url;
    a.download = nombre;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
</script>

<!-- Modal para Agregar Beneficiario -->
<div
  id="modalBeneficiario"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
>
  <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4">
    <!-- Header del modal -->
    <div class="flex items-center justify-between p-6 border-b border-gray-200">
      <div>
        <h3 class="text-lg font-semibold text-gray-900">
          Agregar Beneficiario
        </h3>
        <p class="text-sm text-gray-600 mt-1">
          Para: <span id="nombreTitular" class="font-medium"></span>
        </p>
      </div>
      <button
        onclick="cerrarModalBeneficiario()"
        class="text-gray-400 hover:text-gray-600"
      >
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>

    <!-- Formulario -->
    <form id="formBeneficiario" class="p-6">
      <input type="hidden" id="titularId" name="titular_id" />

      <div class="space-y-4">
        <!-- Nombre -->
        <div>
          <label
            for="nombreBeneficiario"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Nombre completo <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="nombreBeneficiario"
            name="nombre"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="Ingresa el nombre completo"
          />
        </div>

        <!-- Email -->
        <div>
          <label
            for="emailBeneficiario"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Correo electr√≥nico <span class="text-red-500">*</span>
          </label>
          <input
            type="email"
            id="emailBeneficiario"
            name="email"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="ejemplo@correo.com"
          />
        </div>

        <!-- Documento -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de documento <span class="text-red-500">*</span></label>
            <select name="document_type" id="documentTypeBeneficiario" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">Selecciona un tipo de documento</option>
              <option value="cedula">C√©dula</option>
              <option value="pasaporte">Pasaporte</option>
              <option value="nie">NIE</option>
              <option value="dni">DNI</option>
              <option value="otro">Otro</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero de documento <span class="text-red-500">*</span></label>
            <input type="text" name="document_number" id="documentNumberBeneficiario" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ingresa el n√∫mero de documento" />
          </div>
        </div>

        <!-- Fecha de nacimiento -->
        <div>
          <label
            for="fechaNacimiento"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Fecha de nacimiento
          </label>
          <input
            type="date"
            id="fechaNacimiento"
            name="fecha_nacimiento"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>
      </div>

      <!-- Mensaje de estado -->
      <div id="mensajeBeneficiario" class="hidden mt-4 p-3 rounded-lg"></div>

      <!-- Botones -->
      <div class="flex justify-end space-x-3 mt-6">
        <button
          type="button"
          onclick="cerrarModalBeneficiario()"
          class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
        >
          Cancelar
        </button>
        <button
          type="submit"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center"
        >
          <i class="fas fa-user-plus mr-2"></i>
          Agregar Beneficiario
        </button>
      </div>
    </form>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  // Asegurar que las funciones est√©n disponibles globalmente
  if (typeof window.hideAllMenus === "undefined") {
    console.log(
      "üîß Definindo hideAllMenus de respaldo en usuario_carpetas.html..."
    );
    window.hideAllMenus = function () {
      console.log("üîß hideAllMenus de respaldo ejecut√°ndose...");
      const menus = document.querySelectorAll(
        '[id^="file-menu-"], [id^="folder-menu-"]'
      );
      menus.forEach((menu) => {
        if (!menu.classList.contains("hidden")) {
          menu.classList.add("hidden");
        }
      });
    };
  }

  if (typeof window.openUploadModal === "undefined") {
    console.error(
      "‚ùå openUploadModal no est√° definida en usuario_carpetas.html, definiendo funci√≥n de respaldo..."
    );
    window.openUploadModal = function (folderPath, userId) {
      console.log("üîß openUploadModal de respaldo ejecut√°ndose con:", {
        folderPath,
        userId,
      });

      // Buscar el modal
      const modal = document.getElementById("uploadFileModal");
      if (!modal) {
        console.error("‚ùå Modal uploadFileModal no encontrado");
        alert(
          "Error: Modal de subida no encontrado. Recarga la p√°gina e intenta de nuevo."
        );
        return;
      }

      // Buscar o crear los campos necesarios
      let folderInput = modal.querySelector("#uploadFileFolder");
      let userIdInput = modal.querySelector("#uploadFileUsuarioId");

      if (!folderInput) {
        folderInput = document.createElement("input");
        folderInput.type = "hidden";
        folderInput.id = "uploadFileFolder";
        folderInput.name = "carpeta_destino";
        modal.querySelector("#uploadFileForm").appendChild(folderInput);
      }

      if (!userIdInput) {
        userIdInput = document.createElement("input");
        userIdInput.type = "hidden";
        userIdInput.id = "uploadFileUsuarioId";
        userIdInput.name = "usuario_id";
        modal.querySelector("#uploadFileForm").appendChild(userIdInput);
      }

      // Establecer valores
      folderInput.value = folderPath;
      userIdInput.value = userId;

      // Ocultar men√∫s y mostrar modal
      if (typeof window.hideAllMenus === "function") {
        window.hideAllMenus();
      }

      modal.classList.remove("hidden");
      console.log("‚úÖ Modal de subida abierto correctamente");
    };
  }

  // Verificaci√≥n final de funciones disponibles
  console.log("üîç Verificaci√≥n final de funciones en usuario_carpetas.html:");
  console.log("- openUploadModal:", typeof window.openUploadModal);
  console.log("- hideAllMenus:", typeof window.hideAllMenus);
</script>
{% endblock %}
