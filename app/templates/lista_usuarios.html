{% extends "base.html" %}
{% block title %}Lista de Usuarios{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-6 py-8">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-3xl font-bold text-primary-dark">Lista de Usuarios</h1>
      <p class="text-gray-500 mt-1">Gestiona los usuarios del sistema</p>
    </div>
    <a href="{{ url_for('usuarios.lista_usuarios', rol=rol) }}"
       class="bg-blue-100 text-primary-dark rounded-lg px-4 py-2 font-medium hover:bg-blue-200 transition">
      + Agregar usuario
    </a>
  </div>

  <!-- Search -->
  <form method="get" action="{{ url_for('usuarios.lista_usuarios') }}" class="mb-6">
    <div>
      <input type="text" name="q" value="{{ q }}" placeholder="üîç Nombre, email o rol"
            class="w-[32rem] h-[3rem] text-sm px-4 py-3 rounded-xl border border-transparent focus:ring-2 focus:ring-blue-200 focus:outline-none placeholder-gray-400">
    </div>
  </form>

  <!-- Tabla de usuarios -->
  <div class="bg-white rounded-2xl shadow-md border border-gray-100 overflow-hidden">
    <div class="px-6 py-3 border-b bg-blue-50 flex items-center">
      <div class="flex items-center gap-2 text-primary-dark font-semibold">
        <i class="fas fa-users"></i> Usuarios {{ rol|capitalize }}s
      </div>
      <span class="ml-auto text-xs font-bold bg-blue-100 text-primary-dark px-3 py-1 rounded-full">{{ pagination.total }} clientes</span>
    </div>
    <table class="min-w-full text-sm text-gray-700">
      <thead>
        <tr class="border-b text-gray-500">
          <th class="py-3 px-6 text-left">NOMBRE</th>
          <th class="py-3 px-2 text-left">EMAIL</th>
          <th class="py-3 px-2 text-left">CARPETAS</th>
          <th class="py-3 px-2 text-right">ACCIONES</th>
        </tr>
      </thead>
      <tbody>
        {% for u in usuarios %}
        <!-- Fila de tabla en escritorio -->
        <tr 
          class="border-b last:border-0 hover:bg-blue-50 cursor-pointer transition hidden md:table-row"
          onclick="window.location.href='{{ url_for('listar_dropbox.ver_usuario_carpetas', usuario_id=u.id) }}'"
          title="Ver carpetas y archivos de {{ u.nombre or u.email }}"
        >
          <td class="flex items-center gap-3 py-3 px-6">
            <span class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-primary-dark font-bold text-lg">
              {{ (u.nombre or u.email)[0]|upper }}
            </span>
            <div>
              <div class="font-semibold text-gray-900">{{ u.nombre or u.email.split('@')[0] }}</div>
              <div class="text-xs text-gray-500">@{{ u.email.split('@')[0] }}</div>
            </div>
          </td>
          <td class="px-2">{{ u.email }}</td>
          <td class="px-2">
            {% set ncarpetas = carpetas_por_usuario.get(u.id, 0) %}
            {% if ncarpetas > 0 %}
              <span class="bg-blue-100 text-primary-dark px-2.5 py-1 rounded-full text-xs font-semibold">
                {{ ncarpetas }} carpeta{{ 's' if ncarpetas > 1 else '' }}
              </span>
            {% else %}
              <span class="bg-gray-100 text-gray-500 px-2.5 py-1 rounded-full text-xs">Sin carpetas</span>
            {% endif %}
          </td>
          <td class="px-2 text-right">
            <button class="p-2 rounded hover:bg-gray-100 group relative">
              <i class="fas fa-ellipsis-v text-gray-400"></i>
            </button>
          </td>
        </tr>

        <!-- Tarjeta en m√≥vil -->
        <tr class="md:hidden">
          <td colspan="5" class="p-4">
            <div 
              class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 mb-2 hover:bg-blue-50 transition cursor-pointer"
              onclick="window.location.href='{{ url_for('listar_dropbox.ver_usuario_carpetas', usuario_id=u.id) }}'"
              title="Ver carpetas y archivos de {{ u.nombre or u.email }}"
            >
              <div class="flex items-center gap-3 mb-2">
                <span class="w-10 h-10 rounded-full bg-blue-100 text-primary-dark font-bold text-lg flex items-center justify-center">
                  {{ (u.nombre or u.email)[0]|upper }}
                </span>
                <div>
                  <div class="font-semibold text-gray-900 text-base">{{ u.nombre or u.email.split('@')[0] }}</div>
                  <div class="text-xs text-gray-500">@{{ u.email.split('@')[0] }}</div>
                </div>
              </div>
              <div class="text-sm text-gray-700">
                <p><strong>Email:</strong> {{ u.email }}</p>
                <p><strong>Carpetas:</strong>
                  {% set ncarpetas = carpetas_por_usuario.get(u.id, 0) %}
                  {% if ncarpetas > 0 %}
                    <span class="inline-block bg-blue-100 text-primary-dark px-2.5 py-1 rounded-full text-xs font-semibold">
                      {{ ncarpetas }} carpeta{{ 's' if ncarpetas > 1 else '' }}
                    </span>
                  {% else %}
                    <span class="inline-block bg-gray-100 text-gray-500 px-2.5 py-1 rounded-full text-xs">Sin carpetas</span>
                  {% endif %}
                </p>
                <p><strong>Creaci√≥n:</strong>
                  <span class="inline-block text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-full">
                    {{ u.fecha_creacion.strftime('%Y-%m-%d') if u.fecha_creacion else '' }}
                  </span>
                </p>
              </div>
              <div class="flex justify-end mt-3">
                <button class="p-2 rounded hover:bg-gray-100 group relative">
                  <i class="fas fa-ellipsis-v text-gray-400"></i>
                </button>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Paginaci√≥n -->
    <div class="flex items-center justify-between px-6 py-4 border-t bg-gray-50">
      <div class="text-sm text-gray-500">
        Mostrando {{ pagination.start_index }} a {{ pagination.end_index }} de {{ pagination.total }} clientes
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-500 mr-2">Mostrar:</label>
        <select class="text-sm border rounded px-2 py-1 text-gray-600">
          <option>10</option>
          <option>25</option>
          <option>50</option>
        </select>
        <nav class="flex border rounded overflow-hidden text-sm">
          {% if pagination.has_prev %}
            <a href="{{ url_for('usuarios.lista_usuarios', rol=rol, q=q, page=pagination.prev_num) }}"
               class="px-3 py-2 bg-white border-r hover:bg-gray-100">&lt;</a>
          {% else %}
            <span class="px-3 py-2 bg-gray-100 text-gray-400 border-r">&lt;</span>
          {% endif %}
          {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
            {% if p %}
              <a href="{{ url_for('usuarios.lista_usuarios', rol=rol, q=q, page=p) }}"
                 class="px-3 py-2 border-r {{ 'bg-blue-100 text-primary-dark font-bold' if pagination.page == p else 'bg-white hover:bg-gray-100' }}">{{ p }}</a>
            {% else %}
              <span class="px-3 py-2 bg-white border-r">‚Ä¶</span>
            {% endif %}
          {% endfor %}
          {% if pagination.has_next %}
            <a href="{{ url_for('usuarios.lista_usuarios', rol=rol, q=q, page=pagination.next_num) }}"
               class="px-3 py-2 bg-white hover:bg-gray-100">&gt;</a>
          {% else %}
            <span class="px-3 py-2 bg-gray-100 text-gray-400">&gt;</span>
          {% endif %}
        </nav>
      </div>
    </div>
  </div>
</div>
{% endblock %}
