{% extends "base.html" %}
{% block title %}Carpetas de Dropbox{% endblock %}

{% macro render_tree(tree, parent="") %}
<ul class="ml-4 border-l-2 border-gray-200 pl-2">
  {# Mostrar archivos del nivel actual #}
  {% if tree._archivos %}
    {% for archivo in tree._archivos %}
      <li class="text-gray-600"><span class="mr-1">üìÑ</span>{{ archivo }}</li>
    {% endfor %}
  {% endif %}
  {# Mostrar subcarpetas #}
  {% for carpeta, data in tree._subcarpetas.items() %}
    <li class="mb-2">
      <div class="flex items-center cursor-pointer" onclick="toggleFolder('{{ parent ~ '/' ~ carpeta }}')">
        <span id="icon-{{ parent ~ '/' ~ carpeta }}" class="transition-transform mr-1">‚ñ∂Ô∏è</span>
        <span class="font-semibold text-blue-700">{{ carpeta }}</span>
      </div>
      <div class="flex space-x-2 mt-1">
        <form action="{{ url_for('listar_dropbox.crear_carpeta') }}" method="post" class="flex items-center">
          <input type="hidden" name="padre" value="{{ parent ~ '/' ~ carpeta }}">
          <input type="text" name="nombre" placeholder="Nueva subcarpeta" class="border px-1 py-0.5 text-xs rounded" required>
          <button type="submit" class="ml-1 text-xs px-2 py-1 bg-green-500 text-white rounded hover:bg-green-700">Crear</button>
        </form>
      </div>
      <div id="folder-{{ parent ~ '/' ~ carpeta }}" style="display: none;">
        {{ render_tree(data, parent ~ '/' ~ carpeta) }}
      </div>
    </li>
  {% endfor %}
</ul>
{% endmacro %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white rounded-xl shadow-md p-8">
  <h2 class="text-2xl font-bold mb-4">Estructura de Dropbox</h2>

  {# Mensajes flash de √©xito/error #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-4">
        {% for category, message in messages %}
          <div class="p-2 rounded {{ 'bg-green-100 text-green-800' if category=='success' else 'bg-red-100 text-red-800' }}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {# Formulario para crear carpeta ra√≠z #}
  <form action="{{ url_for('listar_dropbox.crear_carpeta') }}" method="post" class="flex mb-6">
    <input type="hidden" name="padre" value="">
    <input type="text" name="nombre" placeholder="Nueva carpeta ra√≠z" class="border px-2 py-1 rounded-l" required>
    <button type="submit" class="bg-blue-600 text-white px-4 py-1 rounded-r hover:bg-blue-800">Crear carpeta ra√≠z</button>
  </form>

  {% if estructura %}
    {{ render_tree(estructura) }}
  {% else %}
    <p class="text-red-500">No se encontraron carpetas.</p>
  {% endif %}
</div>

<script>
function toggleFolder(folderId) {
    const div = document.getElementById('folder-' + folderId);
    const icon = document.getElementById('icon-' + folderId);
    if (!div) return;
    if (div.style.display === "none") {
        div.style.display = "block";
        if (icon) icon.style.transform = "rotate(90deg)";
    } else {
        div.style.display = "none";
        if (icon) icon.style.transform = "rotate(0deg)";
    }
}
</script>
{% endblock %}
